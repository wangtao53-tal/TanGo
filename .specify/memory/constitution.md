<!--
Sync Impact Report:
Version: 2.2.0 → 2.3.0 (流式消息渲染优化、Markdown支持、性能要求和知识卡片交互增强)
修改原则:
  - 原则三：可发布应用规范（新增性能要求：关键接口响应时间≤5秒）
  - 原则八：对话Agent技术规范（明确流式消息实时渲染要求、Markdown格式支持）
  - 原则二：K12 教育游戏化设计规范（新增知识卡片文本转语音交互要求）
模板更新状态:
  - ✅ .specify/templates/plan-template.md (已更新 Constitution Check 部分)
  - ⚠️ .specify/templates/spec-template.md (模板结构保持英文，实际生成内容需遵循中文规范)
  - ⚠️ .specify/templates/tasks-template.md (模板结构保持英文，实际生成内容需遵循中文规范)
-->

# TanGo 项目规范

**版本**: 2.3.0  
**批准日期**: 2025-12-18  
**最后修订日期**: 2025-12-20

## 核心原则

### 原则一：中文优先规范 (NON-NEGOTIABLE)

所有项目文档（Markdown 文件）必须以中文编写。模型生成的内容，除非技术限制必须使用英文（如代码标识符、API 端点名称等），否则必须使用中文生成。

**理由**：确保项目文档的一致性和可读性，便于中文用户理解和使用。

**具体要求**：
- 所有 `.md` 文件内容必须使用中文
- 代码注释优先使用中文
- 用户界面文本必须使用中文
- 技术术语在首次出现时可附加英文原文，后续使用中文

### 原则二：K12 教育游戏化设计规范 (NON-NEGOTIABLE)

项目是面向 K12 中小学生（3-12 岁）的 Web 应用，核心思想是"玩中学"。设计必须：

- **目标用户**：以儿童为切入点，考虑儿童的认知水平和操作习惯
- **设计风格**：不要过于华丽，保持简洁有趣
- **交互体验**：具有游戏玩乐的感觉，让学习过程充满趣味
- **教育目标**：实现面向中国K12学生丰富课外支持的应用，随手拍照识别，随手追问
  - **探索世界**：通过拍照识别物体、场景，激发探索兴趣
  - **学习古诗文**：基于素质教育的学习方式，围绕诗词展开多维度内容拆解
    - 理解作者表达的心情和场景
    - 了解作者同时期的遭遇和感慨
    - 对比不同朝代作者对相似感慨的表达
    - 学习现代人对相同主题的表达方式
    - 培养围绕诗词的完整思维方式
  - **学习英语**：简单单词学习、简单句子学习，循序渐进
- **平衡性**：既要激发探索兴趣，又要与课程内容有机结合
- **多模态交互**：支持文本、语音、图片等多种交互方式，知识卡片支持文本转语音功能

**理由**：确保产品符合目标用户群体的特点，实现寓教于乐的教育目标，提供丰富的课外学习支持。多模态交互提升学习体验，特别是对低龄儿童和阅读能力较弱的学生。

**具体要求**：
- UI/UX 设计必须考虑儿童友好性（大按钮、清晰图标、简单操作流程）
- 交互设计应包含游戏化元素（奖励、进度、成就等）
- 内容设计需平衡趣味性和教育性
- 避免过度复杂或成人化的设计元素
- 支持随手拍照识别和追问的便捷交互
- **知识卡片交互**：
  - 知识卡片必须提供"听"按钮（listen按钮），支持文本转语音功能
  - 文本转语音必须支持中文、英文等多种语言
  - 语音播放必须流畅自然，适合儿童听力
  - 支持播放控制（播放、暂停、停止）

### 原则三：可发布应用规范 (NON-NEGOTIABLE)

实现的应用必须是可以使用、可以发布的生产级应用。遵循MVP优先原则，快速实现页面上所有功能，先确保页面调通，保证功能的完整可用性。关键接口必须满足性能要求，确保用户体验流畅。

**理由**：确保项目具有实际价值，能够真正服务于目标用户。MVP优先原则确保快速迭代和功能完整性。性能要求确保用户不会因等待时间过长而流失。

**具体要求**：
- **MVP优先**：
  - 快速实现页面上所有功能，先确保页面调通
  - 保证功能的完整可用性，避免过度设计
  - 优先实现核心功能流程，确保端到端可用
  - 在功能完整的基础上再优化性能和体验
- **性能要求**：
  - 关键接口响应时间必须≤5秒（如知识卡片生成接口）
  - 流式消息必须实时渲染，不能延迟到最后统一渲染
  - 页面加载时间必须合理，交互响应流畅
  - 必须优化长时间运行的操作（如AI生成），提供进度反馈
- **生产级标准**：
  - 应用必须能够正常运行，无阻塞性错误
  - 必须考虑性能、安全性和可维护性
  - 必须包含必要的错误处理和用户反馈机制
  - 必须考虑部署和发布流程
  - 代码质量必须达到可维护标准

### 原则四：多语言和年级设置规范 (NON-NEGOTIABLE)

支持中英文设置，支持用户年级设置（K12，小学、初中），支持系统设置，默认Web所有都是中文。

**理由**：满足不同用户的语言需求，根据年级提供适配的内容难度，确保教育内容的针对性。

**具体要求**：
- **语言设置**：
  - 系统默认语言为中文
  - 支持用户切换中英文界面
  - 所有Web界面默认显示中文
  - 语言设置应持久化保存（本地存储）
- **年级设置**：
  - 支持K12年级选择（K1-K12，或小学、初中、高中）
  - 支持细分：小学（1-6年级）、初中（7-9年级）
  - 年级设置影响内容难度和知识卡片生成
  - 首次使用时必须选择年级，后续可修改
- **系统设置**：
  - 提供统一的设置入口
  - 设置项包括：语言、年级、其他偏好设置
  - 设置变更立即生效，无需重启应用

### 原则五：AI优先（模型优先）规范 (NON-NEGOTIABLE)

所有AI相关功能（图片识别、文字识别、继续追问等）都统一通过后端调用模型处理，支持流式返回文字和图片内容。**AI Model First**：模型优先，使用Eino框架实现。

**理由**：确保AI能力的一致性、可维护性和可扩展性，提供流畅的实时交互体验。Eino框架提供统一的AI模型调用接口和Graph编排能力。

**具体要求**：
- **统一后端调用**：
  - 所有AI模型调用必须通过后端API实现
  - 前端不直接调用AI模型服务
  - 后端统一管理模型配置、API密钥和调用逻辑
- **Eino框架实现**：
  - 必须使用Eino框架实现所有AI模型调用
  - 使用Eino的ChatModel接口统一管理对话模型
  - 使用Eino的Graph编排能力构建AI工作流
  - 通过Eino框架支持多种AI模型（Ark、OpenAI等）的统一接口
- **流式返回支持**：
  - 支持流式返回文字内容（Streaming Text）
  - 支持流式返回图片内容（Streaming Image）
  - 前端实现流式数据接收和实时渲染
  - 提供加载状态和进度反馈
- **AI功能范围**：
  - 图片识别：物体识别、场景理解等
  - 文字识别：OCR、文本理解等
  - 继续追问：多轮对话、上下文理解等
  - 知识卡片生成：基于识别结果的智能内容生成
- **技术实现**：
  - 使用Server-Sent Events (SSE)实现流式传输
  - 后端使用Eino框架统一管理AI模型调用
  - 实现错误重试和降级策略

### 原则六：移动端优先规范 (NON-NEGOTIABLE)

确保移动端交互的完整性，所有页面UI交互都需要支持点击操作，所有页面有一个统一入口，一键支持拍照，可以随时随地探索。

**理由**：移动端是K12用户的主要使用场景，必须确保移动端体验的完整性和便捷性。

**具体要求**：
- **移动端交互**：
  - 所有UI元素必须支持点击操作（touch事件）
  - 按钮、卡片、链接等交互元素必须有足够的点击区域（最小44x44px）
  - 避免hover-only的交互，所有功能必须通过点击触发
  - 支持手势操作（滑动、长按等）作为辅助交互方式
- **统一拍照入口**：
  - 所有页面必须有一个统一的拍照入口
  - 拍照按钮应固定在页面底部或顶部，易于访问
  - 支持一键快速拍照，减少操作步骤
  - 拍照入口应始终可见，不因页面滚动而隐藏
- **随时随地探索**：
  - 支持在任何页面快速进入拍照模式
  - 拍照后可直接查看结果，无需返回首页
  - 支持快速切换：拍照 → 查看结果 → 继续拍照
  - 优化移动端性能，确保快速响应
- **响应式设计**：
  - 移动端优先设计，然后适配桌面端
  - 确保在小屏幕设备上的可用性（最小320px宽度）
  - 优化移动端加载速度和交互流畅度
  - 考虑移动端网络环境（弱网优化、离线支持）

### 原则七：用户体验流程规范 (NON-NEGOTIABLE)

确保用户交互流程的连贯性和反馈的及时性，优化从识别到对话的完整体验。

**理由**：提供流畅的用户体验，确保用户能够清楚地看到系统响应和交互结果，增强用户对系统的信任和参与度。

**具体要求**：
- **识别后流程**：
  - 拍照识别后，必须直接跳转到问答页面（对话页面）
  - 问答页面必须首先展示识别到的内容（对象名称、类别等）
  - 知识卡片生成应在问答页面中通过对话触发，而不是在识别后立即生成
  - 识别结果应作为对话的初始上下文，支持用户进一步探索
- **消息展示**：
  - 用户发送的所有问题（文本、语音、图片）必须在对话界面中完整展示
  - 追问时，用户发送的问题必须立即显示在对话列表中
  - 消息卡片中暂时不显示图片（简化界面，聚焦内容）
  - 所有消息必须包含时间戳和发送者标识
- **对话反馈**：
  - 用户发送消息后，必须立即在界面中显示用户消息
  - 系统响应应通过流式返回实时展示，提供加载状态
  - 错误情况必须提供清晰的错误提示和恢复建议
- **状态管理**：
  - 对话状态必须正确维护，支持多轮对话
  - 识别结果和对话上下文必须正确关联
  - 页面跳转时，必须正确传递和恢复状态

### 原则八：对话Agent技术规范 (NON-NEGOTIABLE)

对话页发送文本消息和AI对话Agent调用必须基于Eino Graph实现，支持联网获取信息、图文混排输出、SSE流式输出和打字机效果。流式消息必须实时渲染，支持Markdown格式展示。

**理由**：确保对话功能的完整性和用户体验的流畅性，通过Eino Graph实现灵活的AI工作流编排，支持丰富的交互形式。实时渲染确保用户能够及时看到AI响应，Markdown支持提升内容展示质量。

**具体要求**：
- **基于Eino Graph实现**：
  - 对话Agent必须基于Eino Graph实现
  - 使用Eino Graph定义对话工作流和节点编排
  - 通过Graph节点实现不同的AI能力（文本生成、图片生成、工具调用等）
  - 支持Graph节点间的数据流传递和状态管理
- **联网能力支持**：
  - 支持联网获取当前时间和年级对应的课程信息
  - 通过Eino的工具调用（Tool Calling）能力实现联网搜索
  - 根据用户年级动态获取适配的课程内容
  - 支持实时信息查询和知识更新
- **图文混排输出**：
  - 支持文本和图片的混合输出
  - 图片生成需要提供loading占位符，显示生成进度
  - 图片生成完成后无缝替换占位符
  - 支持多张图片的流式生成和展示
- **SSE流式输出**：
  - 必须使用Server-Sent Events (SSE)实现流式输出
  - 支持文本内容的逐字流式返回（打字机效果）
  - 前端实时接收和渲染流式数据
  - 支持流式输出过程中的错误处理和重连机制
- **流式消息实时渲染**：
  - 流式消息必须实时渲染，不能延迟到最后统一渲染
  - 前端接收到SSE数据后必须立即更新UI，不能等待流结束
  - 每个字符或文本片段到达后必须立即显示，实现真正的打字机效果
  - 禁止在流式传输过程中累积内容，最后一次性渲染
- **Markdown格式支持**：
  - 流式消息内容必须支持Markdown格式渲染
  - 前端必须使用Markdown渲染库（如react-markdown）解析和展示内容
  - 支持Markdown常用语法：标题、列表、代码块、链接、粗体、斜体等
  - Markdown渲染必须与流式输出同步，实时更新渲染结果
  - 确保Markdown渲染不影响打字机效果的流畅性
- **打字机效果**：
  - 文本内容必须逐字显示，模拟打字机效果
  - 提供流畅的打字动画，避免卡顿
  - 支持用户中断流式输出（可选）
  - 确保打字机效果不影响用户体验
  - 打字机效果必须与Markdown渲染协调工作
- **技术实现细节**：
  - 后端使用Eino的Stream接口实现流式输出
  - 前端使用EventSource API接收SSE流
  - 前端必须实现增量更新机制，每次收到数据立即更新DOM
  - 前端必须集成Markdown渲染库，支持实时Markdown解析
  - 图片生成节点返回生成进度和最终图片URL
  - 支持对话上下文的维护和多轮对话
  - 错误处理和降级策略必须完善

## 技术约束

### Web 应用架构

- **项目类型**：Web 应用（前端 + 后端）
- **目标平台**：现代浏览器（支持桌面和移动端）
- **响应式设计**：必须支持多种屏幕尺寸，适配平板和手机

### 开发标准

- **代码质量**：遵循最佳实践，代码可读可维护
- **性能要求**：页面加载时间合理，交互响应流畅
- **安全性**：保护用户数据，特别是儿童隐私数据
- **可访问性**：考虑无障碍访问需求

## 治理规则

### 规范优先级

本规范优先于所有其他开发实践和指南。所有代码审查、设计评审和实现决策必须验证是否符合本规范。

### 修订流程

1. **版本管理**：遵循语义化版本（MAJOR.MINOR.PATCH）
   - MAJOR：不兼容的原则变更或移除
   - MINOR：新增原则或重大扩展
   - PATCH：澄清、措辞修正、非语义性改进

2. **修订要求**：
   - 任何原则变更必须记录在 Sync Impact Report 中
   - 修订后必须更新相关模板文件以确保一致性
   - 重大变更需要团队讨论和批准

3. **合规检查**：
   - 所有功能设计和实现计划必须通过规范检查
   - 违反规范的设计必须提供充分理由或调整方案

### 合规审查

- 在功能规划阶段（spec.md）必须验证是否符合所有原则
- 在实现计划阶段（plan.md）必须再次验证规范合规性
- 在任务执行前必须确认不违反任何原则

## 附录

### 相关文档

- 功能规范模板：`.specify/templates/spec-template.md`
- 实现计划模板：`.specify/templates/plan-template.md`
- 任务清单模板：`.specify/templates/tasks-template.md`

### 变更历史

- **v2.3.0** (2025-12-20)：流式消息渲染优化、Markdown支持和性能要求
  - 更新原则三：可发布应用规范，新增性能要求（关键接口≤5秒）
  - 更新原则八：对话Agent技术规范，明确流式消息实时渲染要求和Markdown格式支持
  - 更新原则二：K12教育游戏化设计规范，新增知识卡片文本转语音交互要求
  - 明确流式消息必须实时渲染，不能延迟到最后统一渲染
  - 明确流式消息必须支持Markdown格式渲染
  - 明确知识卡片必须提供文本转语音功能
- **v2.2.0** (2025-12-19)：新增对话Agent技术规范和MVP优先原则
  - 新增原则八：对话Agent技术规范
  - 扩展原则二：K12教育游戏化设计规范，详细描述教育目标（探索世界、学习古诗文、学习英语）
  - 更新原则三：可发布应用规范，新增MVP优先要求
  - 更新原则五：AI优先（模型优先）规范，强调Eino框架实现
  - 明确对话Agent必须基于Eino Graph实现
  - 明确支持联网获取信息、图文混排输出、SSE流式输出和打字机效果
- **v2.1.0** (2025-12-18)：新增用户体验流程规范
  - 新增原则七：用户体验流程规范
  - 明确识别后直接跳转问答页的流程要求
  - 明确消息展示和对话反馈的要求
- **v2.0.0** (2025-12-18)：重大更新，新增三条核心原则
  - 新增原则四：多语言和年级设置规范
  - 新增原则五：AI优先（模型优先）规范
  - 新增原则六：移动端优先规范
- **v1.0.0** (2025-12-18)：初始版本，建立三条核心原则
