// TanGo 对话流式服务 API 定义
// 使用 go-zero API 定义格式
// H5对话落地页 - 流式对话功能

syntax = "v1"

info (
	title: "TanGo 对话流式服务 API"
	desc: "TanGo（小探号）H5对话落地页 - 基于Eino框架的流式对话API"
	version: "1.0.0"
	author: "TanGo Team"
)

type (
	// 流式对话请求
	StreamConversationRequest {
		SessionId             string                 `json:"sessionId,optional"`             // 会话ID，如果为空则创建新会话
		Message               string                 `json:"message"`                       // 用户消息内容
		MessageType           string                 `json:"messageType,optional"`          // 消息类型：text/image/voice，默认text
		Image                 string                 `json:"image,optional"`                // 图片数据（base64或URL），当messageType为image时必填
		Voice                 string                 `json:"voice,optional"`                // 语音数据（base64），当messageType为voice时必填
		IdentificationContext *IdentificationContext `json:"identificationContext,optional"` // 识别结果上下文（可选，用于关联识别结果）
		UserAge               int                    `json:"userAge,optional"`              // 用户年龄（3-18岁），用于内容适配
		MaxContextRounds      int                    `json:"maxContextRounds,optional"`    // 最大上下文轮次，默认20轮
	}

	// 识别结果上下文
	IdentificationContext {
		ObjectName     string   `json:"objectName"`        // 对象名称
		ObjectCategory string   `json:"objectCategory"`    // 对象类别
		Confidence     float64  `json:"confidence"`         // 识别置信度
		Keywords       []string `json:"keywords,optional"`  // 相关关键词
		Age            int      `json:"age,optional"`       // 用户年龄
	}

	// SSE流式事件类型
	StreamEvent {
		Type      string      `json:"type"`                // 事件类型：connected/message/image_progress/image_done/card/error/done
		Content   interface{} `json:"content"`              // 事件内容
		Index     int         `json:"index,optional"`       // 文本消息的字符索引（用于打字机效果）
		Progress  int         `json:"progress,optional"`    // 图片生成进度（0-100）
		SessionId string      `json:"sessionId,optional"`  // 会话ID
		MessageId string      `json:"messageId,optional"`   // 消息ID
	}

	// 对话消息
	ConversationMessage {
		Id            string      `json:"id"`                 // 消息ID
		SessionId     string      `json:"sessionId"`          // 会话ID
		Type          string      `json:"type"`               // 消息类型：text/image/voice/card
		Sender        string      `json:"sender"`             // 发送者：user/assistant
		Content       interface{} `json:"content"`             // 消息内容
		Timestamp     string      `json:"timestamp"`           // 时间戳（ISO 8601格式）
		IsStreaming   *bool       `json:"isStreaming,optional"` // 是否正在流式返回
		StreamingText string      `json:"streamingText,optional"` // 流式文本内容
	}

	// 知识卡片
	KnowledgeCard {
		Id            string      `json:"id"`      // 卡片ID
		Type          string      `json:"type"`    // 卡片类型：science/poetry/english
		Title         string      `json:"title"`   // 卡片标题
		Content       interface{} `json:"content"` // 卡片内容
		ExplorationId string      `json:"explorationId,optional"` // 关联的探索记录ID
	}

	// 错误响应
	ErrorResponse {
		Code    int    `json:"code"`            // 错误码
		Message string `json:"message"`         // 错误信息
		Detail  string `json:"detail,optional"` // 错误详情
	}
)

service conversation {
	// 流式对话接口（SSE）
	// 支持文本流式输出、图片流式输出、图文混排输出、知识卡片输出
	@handler StreamConversationHandler
	get /api/conversation/stream (StreamConversationRequest) returns (stream StreamEvent)

	// 非流式对话接口（兼容性接口）
	@handler ConversationHandler
	post /api/conversation/message (StreamConversationRequest) returns (ConversationMessage)
}

