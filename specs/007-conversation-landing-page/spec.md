# Feature Specification: H5对话落地页

**Feature Branch**: `007-conversation-landing-page`  
**Created**: 2025-12-19  
**Status**: Draft  
**Input**: User description: "构建一个 web H5 对话落地页，当首次拍完照后，对应进行意图识别，三个知识卡片生成（主体卡片、古诗词卡片、英文知识卡片）。然后就是可以追问环节，当用户追问的时候和对应流式接口进行对话，可以打字机效果，支持图片loading占位生成。支持历史消息保存20轮次，然后上下文有一定关联性质，和年纪也有关联性。对应生成贴合对应年龄段的内容，拓展素质教育，课外教育。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 首次拍照后知识卡片生成 (Priority: P1)

用户完成拍照识别后，系统自动进行意图识别，并生成三张知识卡片（主体卡片、古诗词卡片、英文知识卡片），用户可以在对话页面查看这些卡片，开始探索学习。

**Why this priority**: 这是对话落地页的核心入口功能，用户完成拍照识别后需要立即看到学习内容，这是整个对话流程的起点。没有这个功能，用户无法进入对话环节。

**Independent Test**: 可以独立测试：用户拍照识别后，系统自动生成三张知识卡片并展示在对话页面。用户可以看到卡片内容，了解识别对象的相关知识。这个功能可以独立交付价值，即使没有追问功能，用户也能获得基础的学习内容。

**Acceptance Scenarios**:

1. **Given** 用户已完成拍照识别，识别结果包含对象名称、类别、关键词和用户年级信息, **When** 用户进入对话落地页, **Then** 系统自动进行意图识别，识别为"生成卡片"意图
2. **Given** 意图识别完成，识别结果为"生成卡片", **When** 系统开始生成知识卡片, **Then** 系统并行生成三张卡片：主体卡片（科学认知）、古诗词卡片、英文知识卡片
3. **Given** 三张知识卡片生成完成, **When** 卡片数据返回, **Then** 卡片按照固定顺序展示在对话页面：主体卡片、古诗词卡片、英文知识卡片
4. **Given** 卡片内容生成, **When** 卡片展示, **Then** 卡片内容必须贴合用户年级，使用适合该年龄段的理解难度和表达方式

---

### User Story 2 - 追问对话和流式输出 (Priority: P2)

用户在查看知识卡片后，可以继续提问，系统通过流式接口返回回答，支持打字机效果和图片生成loading占位。

**Why this priority**: 追问功能是对话落地页的核心交互功能，用户需要能够继续探索和学习。流式输出和打字机效果提供良好的用户体验，让对话过程更加自然流畅。

**Independent Test**: 可以独立测试：用户在对话页面输入问题，系统通过流式接口返回回答，文本逐字显示（打字机效果），如果包含图片生成，显示loading占位符。这个功能可以独立工作，即使没有历史消息保存，也能完成单轮对话。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面, **When** 用户输入问题并发送, **Then** 用户消息立即显示在对话列表中
2. **Given** 用户消息已发送, **When** 系统开始生成回答, **Then** 系统通过流式接口返回回答，文本内容逐字显示（打字机效果）
3. **Given** 回答中包含图片生成需求, **When** 系统开始生成图片, **Then** 对话中显示loading占位符，显示图片生成进度
4. **Given** 图片生成完成, **When** 图片URL返回, **Then** loading占位符无缝替换为实际图片
5. **Given** 用户进行追问, **When** 系统生成回答, **Then** 回答内容与之前的对话上下文相关，体现上下文关联性

---

### User Story 3 - 历史消息保存和上下文关联 (Priority: P3)

系统保存最近20轮对话历史，在生成回答时使用这些历史消息作为上下文，确保对话的连贯性和相关性。

**Why this priority**: 历史消息保存和上下文关联是提升对话质量的关键功能，让AI能够理解用户的问题背景，提供更准确和相关的回答。虽然可以独立实现前两个功能，但有了这个功能，对话体验会显著提升。

**Independent Test**: 可以独立测试：用户进行多轮对话后，系统保存最近20轮消息。当用户继续提问时，系统使用这些历史消息作为上下文生成回答，回答内容体现对之前对话的理解。可以测试：用户先问"这是什么？"，系统回答后，用户再问"它有什么特点？"，系统能够理解"它"指的是之前讨论的对象。

**Acceptance Scenarios**:

1. **Given** 用户进行对话, **When** 每轮对话完成, **Then** 系统保存用户消息和助手消息到历史记录
2. **Given** 历史消息已保存, **When** 用户进行新一轮提问, **Then** 系统使用最近20轮历史消息作为上下文生成回答
3. **Given** 对话轮次超过20轮, **When** 系统保存新消息, **Then** 系统只保留最近20轮消息，删除更早的消息
4. **Given** 用户在不同会话间切换, **When** 用户返回之前的会话, **Then** 系统能够恢复该会话的历史消息，继续对话
5. **Given** 用户提问涉及之前讨论的内容, **When** 系统生成回答, **Then** 回答内容能够引用和理解之前对话的上下文

---

### Edge Cases

- 当用户拍照识别失败时，系统如何处理？是否仍然显示对话页面？
- 当知识卡片生成失败（部分或全部）时，系统如何处理？是否显示错误提示？
- 当流式输出中断或网络错误时，系统如何处理？是否支持重连和恢复？
- 当图片生成失败时，loading占位符如何处理？是否显示错误提示？
- 当历史消息超过20轮时，如何选择保留哪些消息？是否优先保留最近的对话？
- 当用户年级信息缺失或无效时，系统如何生成内容？是否使用默认年级？
- 当意图识别结果不明确时，系统如何处理？是否回退到默认行为？
- 当用户快速连续发送多条消息时，系统如何处理？是否排队处理？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在用户首次拍照识别完成后，自动进行意图识别，判断用户是否需要生成知识卡片
- **FR-002**: 系统必须在意图识别为"生成卡片"时，并行生成三张知识卡片：主体卡片（科学认知）、古诗词卡片、英文知识卡片
- **FR-003**: 系统必须根据用户年级信息，生成贴合该年龄段理解难度和表达方式的知识卡片内容
- **FR-004**: 系统必须支持用户在对话页面发送文本消息进行追问
- **FR-005**: 系统必须通过流式接口返回对话回答，支持文本内容的逐字流式显示（打字机效果）
- **FR-006**: 系统必须在回答包含图片生成时，显示loading占位符，并在图片生成完成后替换为实际图片
- **FR-007**: 系统必须保存最近20轮对话历史（用户消息和助手消息）
- **FR-008**: 系统必须在生成回答时，使用最近20轮历史消息作为上下文，确保回答的关联性
- **FR-009**: 系统必须根据用户年级信息，生成贴合该年龄段的内容，拓展素质教育和课外教育
- **FR-010**: 系统必须在对话页面展示所有历史消息，包括用户消息和助手消息
- **FR-011**: 系统必须支持对话上下文的维护，确保多轮对话的连贯性
- **FR-012**: 系统必须在流式输出过程中，提供加载状态反馈，让用户知道系统正在处理

### Key Entities *(include if feature involves data)*

- **对话消息**: 包含消息ID、类型（文本/图片/语音/卡片）、内容、发送者（用户/助手）、时间戳、会话ID
- **知识卡片**: 包含卡片ID、类型（主体/古诗词/英文）、标题、内容、关联的识别对象信息
- **对话会话**: 包含会话ID、用户年级、识别结果上下文、历史消息列表（最多20轮）
- **识别结果上下文**: 包含对象名称、对象类别、关键词、识别时间，作为对话的初始上下文
- **用户年级信息**: 包含年级值（3-18岁），影响内容生成的难度和表达方式

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在拍照识别完成后，能够在3秒内看到三张知识卡片生成并展示在对话页面
- **SC-002**: 用户发送追问消息后，系统能够在1秒内开始返回流式回答，打字机效果流畅无卡顿
- **SC-003**: 图片生成时，loading占位符能够正确显示，图片生成完成后能够在2秒内完成替换
- **SC-004**: 系统能够正确保存最近20轮对话历史，用户刷新页面后能够恢复历史消息
- **SC-005**: 系统生成的回答内容与对话上下文相关，90%的回答能够正确引用和理解之前讨论的内容
- **SC-006**: 系统生成的知识卡片和对话内容贴合用户年级，内容难度适合该年龄段的理解水平
- **SC-007**: 用户能够完成从拍照识别到知识卡片生成再到追问对话的完整体验流程，流程中断率低于5%
- **SC-008**: 系统支持并发用户进行对话，单个用户对话响应时间不受其他用户影响

## Assumptions

- 用户已经完成拍照识别，识别结果包含对象名称、类别、关键词和用户年级信息
- 用户年级信息在系统设置中已配置，范围为3-18岁（K12）
- 网络连接稳定，支持流式数据传输
- 浏览器支持Server-Sent Events (SSE)和EventSource API
- 后端AI模型服务可用，能够生成知识卡片和对话回答
- 图片生成服务可用，能够生成并返回图片URL
- 用户设备性能足够支持流式渲染和打字机效果

## Dependencies

- 依赖拍照识别功能：用户必须先完成拍照识别，才能进入对话落地页
- 依赖意图识别服务：系统需要调用意图识别API判断用户意图
- 依赖知识卡片生成服务：系统需要调用卡片生成API生成三张知识卡片
- 依赖流式对话服务：系统需要调用流式对话API返回回答
- 依赖图片生成服务：系统需要调用图片生成API生成图片
- 依赖用户年级设置：系统需要获取用户年级信息以生成适配内容
- 依赖历史消息存储：系统需要存储和检索对话历史消息

## Out of Scope

- 不支持语音输入和语音输出（语音功能在其他功能中实现）
- 不支持图片上传作为对话输入（图片上传功能在其他功能中实现）
- 不支持多用户协作对话（单用户对话场景）
- 不支持对话消息的编辑和删除（只读历史记录）
- 不支持对话消息的导出和分享（分享功能在其他功能中实现）
- 不支持自定义知识卡片类型（固定三种卡片类型）
- 不支持对话历史的跨设备同步（本地存储）
