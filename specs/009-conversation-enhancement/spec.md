# Feature Specification: 对话页面完善

**Feature Branch**: `009-conversation-enhancement`  
**Created**: 2025-12-21  
**Status**: Draft  
**Input**: User description: "对话页面完善，支持文本输入、语音输入、图片输入； 输出有三个卡片输出，流式输出，图文混排输出。对话页-语音输入后，支持Agent模型流式返回内容，而不是Mock数据；对话页-上传图片后，支持Agent模型流式返回内容，而不是Mock数据；"

## Clarifications

### Session 2025-12-21

- Q: 接口设计方式 → A: 统一接口设计：对话页面使用一个统一的流式接口，支持文本输入、图片输入、语音输入，一个接口搞定所有输入和输出。除了生成知识卡片使用另一个独立接口。
- Q: 统一接口的输入处理方式 → A: 统一接口通过 `messageType` 字段明确指定输入类型：请求中必须包含 `messageType: "text"|"voice"|"image"` 字段，接口根据该字段处理相应的输入类型
- Q: Mock数据与AI模型调用配置 → A: 在.env配置文件中新增字段 `USE_AI_MODEL`（布尔值），支持配置是否使用AI模型调用。默认值为 `true`（使用AI模型），设置为 `false` 时使用Mock数据。本次实现默认全部采用AI模型调用。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 文本输入和流式输出 (Priority: P1)

用户在对话页面通过文本输入框输入问题，通过统一流式接口发送文本消息，系统通过Agent模型流式返回回答，支持打字机效果和Markdown格式渲染。

**Why this priority**: 文本输入是对话页面最基础、最常用的交互方式，是其他输入方式的基础。流式输出提供良好的用户体验，让用户能够实时看到AI响应。

**Independent Test**: 可以独立测试：用户在对话页面输入文本问题，通过统一流式接口发送，系统通过Agent模型流式返回回答，文本逐字显示（打字机效果），支持Markdown格式渲染。这个功能可以独立交付价值，即使没有语音和图片输入，用户也能完成对话交互。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面, **When** 用户在文本输入框中输入问题并点击发送, **Then** 通过统一流式接口发送文本消息，用户消息立即显示在对话列表中
2. **Given** 用户文本消息已通过统一流式接口发送, **When** 系统开始生成回答, **Then** 系统通过Agent模型流式返回回答，文本内容逐字显示（打字机效果），支持Markdown格式渲染
3. **Given** 回答中包含代码块、列表、链接等Markdown元素, **When** 文本流式返回, **Then** Markdown格式实时渲染，不影响打字机效果的流畅性
4. **Given** 用户进行多轮文本对话, **When** 系统生成回答, **Then** 回答内容与之前的对话上下文相关，体现上下文关联性

---

### User Story 2 - 语音输入和Agent模型流式返回 (Priority: P1)

用户在对话页面通过语音输入功能录制语音，通过统一流式接口发送语音数据，系统自动将语音转换为文本后，通过Agent模型流式返回回答，禁止使用Mock数据。

**Why this priority**: 语音输入是对话页面的核心功能之一，特别适合移动端用户和低龄儿童。Agent模型流式返回确保用户获得有价值的AI响应，提升产品实用性。这是用户明确要求的功能，必须使用真实模型。

**Independent Test**: 可以独立测试：用户在对话页面点击语音输入按钮，录制语音，通过统一流式接口发送语音数据，系统自动将语音转换为文本，然后通过Agent模型流式返回回答。这个功能可以独立工作，即使没有文本和图片输入，用户也能通过语音完成对话交互。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面, **When** 用户点击语音输入按钮并开始录制, **Then** 系统显示录音状态，用户可以看到录音时长和波形
2. **Given** 用户完成语音录制, **When** 用户停止录制并调用统一流式接口发送语音数据, **Then** 系统自动将语音转换为文本，用户消息（包含语音和文本）立即显示在对话列表中
3. **Given** 语音已转换为文本, **When** 统一接口开始生成回答, **Then** 系统通过Agent模型（基于Eino Graph）流式返回回答，禁止使用Mock数据
4. **Given** Agent模型流式返回回答, **When** 文本内容逐字返回, **Then** 文本逐字显示（打字机效果），支持Markdown格式渲染
5. **Given** Agent模型调用失败, **When** 系统无法生成回答, **Then** 系统记录详细错误日志，向用户显示友好的错误提示，不允许降级到Mock数据

---

### User Story 3 - 图片输入和Agent模型流式返回 (Priority: P1)

用户在对话页面通过图片输入功能选择图片，通过统一流式接口发送图片数据，系统自动上传图片获取URL后，通过Agent模型流式返回回答，支持图文混排输出，禁止使用Mock数据。

**Why this priority**: 图片输入是对话页面的核心功能之一，用户可以通过上传图片进行多模态对话。Agent模型流式返回确保用户获得有价值的AI响应。图文混排输出提供丰富的交互形式，提升用户体验。这是用户明确要求的功能，必须使用真实模型。

**Independent Test**: 可以独立测试：用户在对话页面点击图片输入按钮，选择图片，通过统一流式接口发送图片数据，系统自动上传图片获取URL，然后通过Agent模型流式返回回答，支持文本和图片的混合输出。这个功能可以独立工作，即使没有文本和语音输入，用户也能通过图片完成对话交互。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面, **When** 用户点击图片输入按钮并选择图片, **Then** 图片立即显示在对话列表中作为用户消息
2. **Given** 用户选择图片并调用统一流式接口发送图片数据, **When** 系统自动上传图片获取URL, **Then** 系统通过Agent模型（基于Eino Graph）流式返回回答，禁止使用Mock数据
3. **Given** Agent模型流式返回回答, **When** 回答中包含文本和图片, **Then** 文本内容逐字显示（打字机效果），图片生成时显示loading占位符
4. **Given** 图片生成完成, **When** 图片URL返回, **Then** loading占位符无缝替换为实际图片，实现图文混排输出
5. **Given** Agent模型调用失败, **When** 系统无法生成回答, **Then** 系统记录详细错误日志，向用户显示友好的错误提示，不允许降级到Mock数据

---

### User Story 4 - 三个卡片输出 (Priority: P2)

当用户触发生成卡片意图时，系统通过独立的生成知识卡片接口生成三张知识卡片（主体卡片、古诗词卡片、英文知识卡片），通过流式方式返回，支持卡片内容的实时渲染。

**Why this priority**: 三个卡片输出是对话页面的重要功能，为用户提供结构化的学习内容。流式返回提供良好的用户体验，让用户能够实时看到卡片生成进度。注意：生成知识卡片使用独立的接口，不是统一对话接口。

**Independent Test**: 可以独立测试：用户触发生成卡片意图（如输入"生成卡片"），系统调用独立的生成知识卡片接口，通过Agent模型流式生成三张知识卡片，卡片内容实时显示在对话页面。这个功能可以独立工作，即使没有其他对话功能，用户也能获得知识卡片。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面, **When** 用户触发生成卡片意图（如输入"生成卡片"或相关关键词）, **Then** 系统识别为"生成卡片"意图
2. **Given** 意图识别为"生成卡片", **When** 系统调用独立的生成知识卡片接口开始生成卡片, **Then** 系统通过Agent模型流式生成三张知识卡片：主体卡片（科学认知）、古诗词卡片、英文知识卡片
3. **Given** 卡片生成过程中, **When** 卡片内容流式返回, **Then** 卡片内容实时显示在对话页面，支持流式渲染
4. **Given** 三张卡片生成完成, **When** 卡片数据返回, **Then** 卡片按照固定顺序展示：主体卡片、古诗词卡片、英文知识卡片

---

### User Story 5 - 图文混排输出 (Priority: P2)

系统在生成回答时，支持文本和图片的混合输出，图片生成时显示loading占位符，生成完成后无缝替换。

**Why this priority**: 图文混排输出提供丰富的交互形式，让AI回答更加生动和直观。这对于K12教育场景特别重要，图片可以帮助儿童更好地理解内容。

**Independent Test**: 可以独立测试：系统生成包含图片的回答时，文本内容逐字显示，图片生成时显示loading占位符，生成完成后无缝替换为实际图片。这个功能可以独立工作，提升用户体验。

**Acceptance Scenarios**:

1. **Given** 系统生成回答, **When** 回答中包含图片生成需求, **Then** 对话中显示loading占位符，显示图片生成进度
2. **Given** 图片生成过程中, **When** 文本内容继续流式返回, **Then** 文本内容逐字显示（打字机效果），不影响图片loading占位符的显示
3. **Given** 图片生成完成, **When** 图片URL返回, **Then** loading占位符无缝替换为实际图片，实现图文混排输出
4. **Given** 回答中包含多张图片, **When** 图片依次生成, **Then** 每张图片都有独立的loading占位符，生成完成后依次替换

---

### Edge Cases

- **网络错误处理**：当Agent模型调用失败时，系统必须记录详细错误日志，向用户显示友好的错误提示。当 `USE_AI_MODEL=true`（默认值）时，不允许降级到Mock数据；当 `USE_AI_MODEL=false` 时，可以使用Mock数据作为降级方案
- **配置字段验证**：系统必须正确读取和应用 `.env` 配置文件中的 `USE_AI_MODEL` 字段，默认值为 `true`（使用AI模型）
- **流式中断处理**：当流式输出过程中网络中断时，系统应支持重连机制，恢复流式输出
- **图片上传失败**：当图片上传失败时，系统应使用base64格式降级处理，确保图片能够正常发送
- **语音识别失败**：当语音识别失败时，系统应向用户显示友好的错误提示，允许用户重新录制
- **统一接口输入类型识别**：当统一接口接收到请求时，系统必须根据请求中的 `messageType` 字段识别输入类型（text/voice/image），并进行相应处理。当 `messageType` 为 `"voice"` 时，系统自动进行语音识别；当 `messageType` 为 `"image"` 时，系统自动上传图片获取URL；当 `messageType` 为 `"text"` 时，直接使用文本消息
- **卡片生成超时**：当卡片生成超时（超过5秒）时，系统应向用户显示进度提示，允许用户取消操作
- **Markdown渲染错误**：当Markdown格式错误导致渲染失败时，系统应降级为纯文本显示，不影响对话流程
- **并发对话处理**：当用户快速连续发送多条消息时，系统应正确处理消息队列，确保每条消息都能得到响应

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 对话页面必须使用一个统一的流式接口，支持文本输入、语音输入、图片输入三种输入方式
- **FR-002**: 统一接口必须通过 `messageType` 字段明确指定输入类型：请求中必须包含 `messageType: "text"|"voice"|"image"` 字段，接口根据该字段处理相应的输入类型
- **FR-003**: 统一接口必须支持文本输入功能，用户可以通过文本输入框输入问题并发送
- **FR-004**: 统一接口必须支持语音输入功能：接收语音数据后，自动进行语音识别转换为文本，然后调用Agent模型
- **FR-005**: 统一接口必须支持图片输入功能：接收图片数据后，自动进行图片上传获取URL，然后调用Agent模型（支持多模态输入）
- **FR-006**: 统一接口必须通过Agent模型（基于Eino Graph）流式返回回答，默认使用AI模型调用（通过配置 `USE_AI_MODEL=true` 控制）
- **FR-007**: 系统必须在.env配置文件中支持 `USE_AI_MODEL` 字段（布尔值），用于控制是否使用AI模型调用，默认值为 `true`（使用AI模型）
- **FR-008**: 统一接口必须支持所有输出类型：文本流式输出、图文混排输出，通过同一个接口返回
- **FR-009**: 统一接口必须支持流式输出，文本内容逐字显示（打字机效果）
- **FR-010**: 统一接口必须支持Markdown格式渲染，流式输出过程中实时渲染Markdown内容
- **FR-011**: 系统必须支持三个卡片输出（主体卡片、古诗词卡片、英文知识卡片），通过独立的生成知识卡片接口返回（不是统一对话接口）
- **FR-012**: 统一接口必须支持图文混排输出，图片生成时显示loading占位符，生成完成后无缝替换
- **FR-013**: 统一接口必须支持多轮对话，维护对话上下文，确保回答内容与之前的对话相关
- **FR-014**: 当Agent模型调用失败时，统一接口必须记录详细错误日志，向用户显示友好的错误提示。当 `USE_AI_MODEL=true` 时，不允许降级到Mock数据；当 `USE_AI_MODEL=false` 时，可以使用Mock数据作为降级方案
- **FR-014**: 统一接口必须支持流式输出过程中的错误处理和重连机制
- **FR-015**: 统一接口必须支持图片上传失败时的降级处理（使用base64格式）
- **FR-016**: 统一接口必须支持语音识别失败时的错误处理和用户重试机制
- **FR-017**: 统一接口的请求格式必须包含 `messageType` 字段（必填）：`"text"`、`"voice"` 或 `"image"`，根据 `messageType` 的值，请求必须包含对应的字段：`message`（文本，当messageType为text时必填）、`audio`（语音base64，当messageType为voice时必填）、`image`（图片base64或URL，当messageType为image时必填）

### Key Entities *(include if feature involves data)*

- **统一流式对话请求（UnifiedStreamConversationRequest）**：包含 `messageType`（必填，text/voice/image）、`message`（文本，当messageType为text时必填）、`audio`（语音base64，当messageType为voice时必填）、`image`（图片base64或URL，当messageType为image时必填）、`sessionId`（可选）、`identificationContext`（可选）、`userAge`（可选）、`maxContextRounds`（可选）等属性
- **对话消息（ConversationMessage）**：包含消息ID、类型（text/voice/image）、内容、时间戳、发送者（user/assistant）、会话ID、流式文本、Markdown标识等属性
- **会话（Session）**：包含会话ID、用户年龄、识别结果上下文、消息列表等属性
- **知识卡片（KnowledgeCard）**：包含卡片类型（science/poetry/english）、标题、内容等属性
- **流式事件（StreamEvent）**：包含事件类型（message/done/error）、内容、索引、会话ID、消息ID、Markdown标识等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以通过文本、语音、图片三种方式输入消息，输入成功率≥95%
- **SC-002**: 语音输入后，系统通过Agent模型流式返回回答的成功率≥90%（当 `USE_AI_MODEL=true` 时，必须使用AI模型，禁止使用Mock数据）
- **SC-003**: 图片上传后，系统通过Agent模型流式返回回答的成功率≥90%（当 `USE_AI_MODEL=true` 时，必须使用AI模型，禁止使用Mock数据）
- **SC-004**: 流式输出响应时间≤5秒（从用户发送消息到开始接收流式响应）
- **SC-005**: 流式输出过程中，文本逐字显示的延迟≤100ms（每个字符到达后立即显示）
- **SC-006**: Markdown格式渲染准确率≥95%（正确渲染代码块、列表、链接等元素）
- **SC-007**: 三个卡片生成的完整时间≤10秒（从触发到三张卡片全部显示）
- **SC-008**: 图文混排输出中，图片loading占位符显示时间≤3秒（从开始生成到显示占位符）
- **SC-009**: 图文混排输出中，图片生成完成时间≤15秒（从开始生成到实际图片显示）
- **SC-010**: 多轮对话中，回答内容与上下文的相关性≥80%（通过用户满意度评估）
- **SC-011**: Agent模型调用失败时，错误日志记录率100%，用户错误提示显示率100%。当 `USE_AI_MODEL=true` 时，不允许降级到Mock数据
- **SC-013**: 配置字段 `USE_AI_MODEL` 必须正确读取和应用，默认值为 `true`（使用AI模型）
- **SC-012**: 流式输出中断后，重连成功率≥80%

## Assumptions

- 用户已经完成拍照识别，识别结果包含对象名称、类别、关键词和用户年级信息
- 系统已经配置好Agent模型（基于Eino Graph），支持流式输出
- 系统配置文件中已设置 `USE_AI_MODEL=true`（默认值），使用AI模型调用，不使用Mock数据
- 前端已经实现SSE（Server-Sent Events）流式接收机制
- 前端已经集成Markdown渲染库（如react-markdown），支持实时Markdown解析
- 语音识别服务已经配置好，支持将语音转换为文本
- 图片上传服务已经配置好，支持图片上传和存储
- 系统已经实现对话上下文管理，支持多轮对话
- 用户年级信息已经获取，用于内容适配

## Dependencies

- Agent模型（基于Eino Graph）必须可用，支持流式输出（当 `USE_AI_MODEL=true` 时）
- 系统配置文件（.env）必须包含 `USE_AI_MODEL` 字段，默认值为 `true`（使用AI模型）
- 统一流式对话接口必须实现，支持文本、语音、图片三种输入类型
- 语音识别服务必须可用，支持将语音转换为文本（集成到统一接口中）
- 图片上传服务必须可用，支持图片上传和存储（集成到统一接口中）
- 独立的生成知识卡片接口必须实现，用于生成三张知识卡片
- 前端SSE流式接收机制必须可用
- 前端Markdown渲染库必须可用
- 对话上下文管理机制必须可用

## Configuration

### 环境变量配置

系统支持通过 `.env` 配置文件控制是否使用AI模型调用：

- **USE_AI_MODEL**（布尔值，可选，默认值：`true`）
  - `true`: 使用AI模型调用，禁止使用Mock数据（默认值，本次实现采用此配置）
  - `false`: 使用Mock数据作为降级方案（仅用于开发测试场景）
  
**配置示例**:
```bash
# .env 文件
USE_AI_MODEL=true  # 使用AI模型调用（默认值）
```

**实现要求**:
- 在 `backend/internal/config/config.go` 的 `AIConfig` 结构体中添加 `UseAIModel` 字段
- 从环境变量 `USE_AI_MODEL` 读取配置，默认值为 `true`
- 在统一接口处理逻辑中，根据 `UseAIModel` 配置决定是否使用AI模型
- 当 `UseAIModel=true` 时，禁止降级到Mock数据
- 当 `UseAIModel=false` 时，可以使用Mock数据作为降级方案
