# 功能规范：TanGo 交互功能与AI对话系统

**功能分支**: `002-interactive-features`  
**创建日期**: 2025-12-18  
**状态**: 草稿  
**输入**: 用户描述：实现前端所有按钮的逻辑功能、中英文支持、对话式交互、卡片收藏导出、AI模型调用与Agent系统

## 澄清

### Session 2025-12-18

- Q: 前端按钮逻辑功能的具体范围？ → A: 所有页面按钮必须有真实功能，包括拍照、相册选择、语音输入、收藏、导出、设置等，不能是假逻辑或点击无反应
- Q: 统一拍照入口的实现方式？ → A: 所有页面必须有一个快速回到首页拍照的功能按钮，固定在页面底部或顶部，始终可见
- Q: 中英文切换的实现方式？ → A: 支持中英文切换，默认中文，语言设置持久化保存，切换后立即生效
- Q: 对话消息列表的实现方式？ → A: 生成的三个卡片显示在对话消息列表中，支持继续追问，支持文本、语音、图片输入，根据意图识别决定输出文本或重新生成卡片
- Q: 卡片收藏和导出的实现方式？ → A: 支持卡片收藏，收藏后可以导出成图片，卡片页面细节需要细化，卡片大小符合设计规范，不能被压缩
- Q: 数据存储的实现方式？ → A: 服务端存储到内存缓存中，前端存储在本地缓存（IndexedDB + localStorage），支持数据同步
- Q: AI模型调用的实现方式？ → A: 使用eino框架搭建Agent系统，可以用单Agent，用graph图串联整个流程，区分拍照图片识别、三个卡片图片生成、文本生成等不同功能
- Q: 继续追问的意图识别逻辑？ → A: 支持文本、语音、图片输入，根据意图识别决定输出文本或三个卡片，三个卡片是明确的意图（如"帮我生成小卡片"）
- Q: AI模型调用的具体API规范？ → A: 通过go-zero + eino框架调用，AI服务地址和认证信息存储在根目录的.env配置文件中，使用Bearer Token认证（`${TAL_MLOPS_APP_ID}:${TAL_MLOPS_APP_KEY}`），不将具体域名写入MD文档

## 用户场景与测试 *(必填)*

### 用户故事 1 - 完整的交互功能实现（优先级: P1）

用户在使用应用时，所有按钮都有真实的功能响应，包括拍照、相册选择、语音输入、收藏、导出等，所有页面都有快速回到首页拍照的功能。

**为什么是最高优先级**：这是用户体验的基础，如果按钮没有真实功能，用户无法正常使用应用，会严重影响用户体验和产品可用性。

**独立测试**：可以完全独立测试，点击所有页面的按钮，验证每个按钮都有真实的功能响应，没有假逻辑或点击无反应的情况。

**接受场景**：

1. **Given** 用户在首页，**When** 点击拍照按钮，**Then** 系统打开相机或相册选择界面，支持拍照和选择相册图片
2. **Given** 用户在首页，**When** 点击语音输入按钮，**Then** 系统启动语音识别，支持语音输入
3. **Given** 用户在任何页面，**When** 点击快速拍照按钮，**Then** 系统立即跳转到拍照页面，支持快速拍照
4. **Given** 用户在结果页面，**When** 点击收藏按钮，**Then** 卡片被收藏到本地，收藏状态立即更新
5. **Given** 用户在收藏页面，**When** 点击导出按钮，**Then** 卡片被导出为图片，可以保存到本地

---

### 用户故事 2 - 中英文切换功能（优先级: P1）

用户可以根据需要切换应用语言，支持中文和英文，默认语言为中文，语言设置持久化保存。

**为什么是最高优先级**：这是项目规范要求（原则四），必须支持多语言设置，满足不同用户的语言需求。

**独立测试**：可以完全独立测试，在设置页面切换语言，验证界面语言立即更新，刷新页面后语言设置仍然保持。

**接受场景**：

1. **Given** 用户首次打开应用，**When** 查看界面，**Then** 所有文本默认显示为中文
2. **Given** 用户在设置页面，**When** 切换语言为英文，**Then** 界面立即更新为英文，所有文本都切换为英文
3. **Given** 用户切换语言后，**When** 刷新页面，**Then** 语言设置仍然保持，界面显示为上次选择的语言
4. **Given** 用户在设置页面，**When** 切换语言为中文，**Then** 界面立即更新为中文，所有文本都切换为中文

---

### 用户故事 3 - 对话式交互与卡片展示（优先级: P1）

用户拍照后生成的三个卡片显示在对话消息列表中，支持继续追问，支持文本、语音、图片输入，根据意图识别决定输出文本或重新生成卡片。

**为什么是最高优先级**：这是核心交互体验，对话式交互让用户感觉更自然，支持多轮对话和多种输入方式，提升用户体验。

**独立测试**：可以完全独立测试，拍照生成卡片后，在对话消息列表中继续输入文本、语音或图片，验证系统能正确识别意图并返回相应内容。

**接受场景**：

1. **Given** 用户拍照后，**When** 系统生成三个卡片，**Then** 卡片显示在对话消息列表中，每个卡片作为一个消息项
2. **Given** 用户在对话消息列表中，**When** 输入文本"这是什么植物？"，**Then** 系统识别意图，返回文本回答
3. **Given** 用户在对话消息列表中，**When** 输入"帮我生成小卡片"，**Then** 系统识别意图为生成卡片，触发重新生成三个卡片的逻辑
4. **Given** 用户在对话消息列表中，**When** 输入语音消息，**Then** 系统识别语音内容，根据意图返回文本或生成卡片
5. **Given** 用户在对话消息列表中，**When** 上传图片，**Then** 系统识别图片内容，根据意图返回文本或生成卡片

---

### 用户故事 4 - 卡片收藏与导出功能（优先级: P2）

用户可以对卡片进行收藏，收藏后可以导出成图片，卡片页面细节需要细化，卡片大小符合设计规范。

**为什么是第二优先级**：这是增强功能，提升用户体验，但不是核心功能，可以在核心功能实现后再实现。

**独立测试**：可以完全独立测试，在结果页面或对话消息列表中点击收藏按钮，然后在收藏页面查看收藏的卡片，点击导出按钮验证卡片能导出为图片。

**接受场景**：

1. **Given** 用户在结果页面，**When** 点击卡片上的收藏按钮，**Then** 卡片被收藏，收藏状态立即更新，按钮图标变为已收藏状态
2. **Given** 用户在收藏页面，**When** 查看收藏的卡片，**Then** 卡片显示完整，细节清晰，大小符合设计规范，没有被压缩
3. **Given** 用户在收藏页面，**When** 点击导出按钮，**Then** 卡片被导出为图片，可以保存到本地相册或分享
4. **Given** 用户在卡片详情页面，**When** 查看卡片，**Then** 卡片页面细节完整，包括标题、内容、图片等所有元素都清晰可见

---

### 用户故事 5 - 数据存储与同步（优先级: P2）

用户的所有数据（探索记录、收藏卡片等）存储在本地缓存中，服务端也存储到内存缓存中，支持数据同步。

**为什么是第二优先级**：这是数据持久化的基础功能，确保用户数据不丢失，但不是核心交互功能。

**独立测试**：可以完全独立测试，进行多次探索和收藏操作，刷新页面后验证数据仍然存在，关闭应用后重新打开验证数据仍然保持。

**接受场景**：

1. **Given** 用户进行探索和收藏操作，**When** 数据保存，**Then** 前端数据存储在本地缓存（IndexedDB + localStorage），服务端数据存储在内存缓存中
2. **Given** 用户刷新页面，**When** 重新打开应用，**Then** 所有本地数据仍然存在，可以正常查看
3. **Given** 用户关闭应用后重新打开，**When** 查看收藏和探索记录，**Then** 所有数据仍然保持，没有丢失
4. **Given** 用户在不同设备上使用，**When** 查看数据，**Then** 数据在各自设备上独立存储，不跨设备同步（MVP版本）

---

### 用户故事 6 - AI模型调用与Agent系统（优先级: P1）

系统使用eino框架搭建Agent系统，通过graph图串联整个流程，区分拍照图片识别、三个卡片图片生成、文本生成等不同功能。

**为什么是最高优先级**：这是AI能力的核心实现，必须通过后端统一调用AI模型，使用eino框架搭建Agent系统，确保AI能力的一致性和可扩展性。

**独立测试**：可以完全独立测试，拍照后验证系统能正确调用AI模型进行图片识别，然后生成三个卡片，验证Agent系统能正确串联整个流程。

**接受场景**：

1. **Given** 用户拍照后，**When** 系统调用AI模型，**Then** 后端通过eino框架调用图片识别模型，返回识别结果
2. **Given** 系统获得识别结果，**When** 生成三个卡片，**Then** 后端通过eino框架调用文本生成模型，生成三个卡片的内容
3. **Given** 系统生成卡片内容，**When** 需要生成卡片图片，**Then** 后端通过eino框架调用图片生成模型，生成卡片配图
4. **Given** 用户在对话中继续追问，**When** 系统识别意图，**Then** 后端通过eino框架的Agent系统，根据意图调用相应的模型，返回文本或生成卡片

---

### 用户故事 7 - 多模态输入与意图识别（优先级: P1）

用户支持文本输入、语音输入、图片输入，系统根据意图识别，输出文本或三个卡片，三个卡片是明确的意图。

**为什么是最高优先级**：这是对话式交互的核心功能，支持多种输入方式，根据意图智能返回相应内容，提升用户体验。

**独立测试**：可以完全独立测试，在对话消息列表中输入文本、语音或图片，验证系统能正确识别意图，返回文本或生成卡片。

**接受场景**：

1. **Given** 用户在对话消息列表中，**When** 输入文本消息，**Then** 系统识别文本意图，根据意图返回文本回答或生成卡片
2. **Given** 用户在对话消息列表中，**When** 输入语音消息，**Then** 系统识别语音内容，转换为文本后识别意图，返回相应内容
3. **Given** 用户在对话消息列表中，**When** 上传图片，**Then** 系统识别图片内容，根据意图返回文本回答或生成卡片
4. **Given** 用户输入"帮我生成小卡片"，**When** 系统识别意图，**Then** 系统识别为生成卡片意图，触发重新生成三个卡片的逻辑
5. **Given** 用户输入普通问题，**When** 系统识别意图，**Then** 系统识别为文本回答意图，返回文本回答

---

### 边界情况

- **网络异常**：当网络不可用时，系统如何处理？应提示用户网络异常，支持离线查看已缓存的数据
- **AI模型调用失败**：当AI模型调用失败时，系统如何处理？应提示用户错误，支持重试，必要时降级到Mock数据
- **图片过大**：当用户上传的图片过大时，系统如何处理？应自动压缩图片，确保上传速度
- **语音识别失败**：当语音识别失败时，系统如何处理？应提示用户重新输入，支持重试
- **意图识别不明确**：当意图识别不明确时，系统如何处理？应返回提示，询问用户具体需求
- **卡片导出失败**：当卡片导出失败时，系统如何处理？应提示用户错误，支持重试
- **数据存储失败**：当数据存储失败时，系统如何处理？应提示用户错误，支持重试，必要时使用临时存储

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持所有按钮的真实功能响应，不能有假逻辑或点击无反应
- **FR-002**: 系统必须支持首页拍照、相册选择、语音输入三种输入方式
- **FR-003**: 系统必须在所有页面提供快速回到首页拍照的功能按钮
- **FR-004**: 系统必须支持中英文切换，默认语言为中文
- **FR-005**: 系统必须支持语言设置的持久化保存，刷新页面后仍然保持
- **FR-006**: 系统必须将生成的三个卡片显示在对话消息列表中
- **FR-007**: 系统必须支持在对话消息列表中继续追问
- **FR-008**: 系统必须支持文本、语音、图片三种输入方式
- **FR-009**: 系统必须根据意图识别决定输出文本或重新生成卡片
- **FR-010**: 系统必须支持卡片收藏功能，收藏状态立即更新
- **FR-011**: 系统必须支持卡片导出为图片功能
- **FR-012**: 系统必须确保卡片页面细节完整，卡片大小符合设计规范
- **FR-013**: 系统必须支持前端数据存储在本地缓存（IndexedDB + localStorage）
- **FR-014**: 系统必须支持服务端数据存储在内存缓存中
- **FR-015**: 系统必须使用eino框架搭建Agent系统
- **FR-016**: 系统必须通过graph图串联整个AI调用流程
- **FR-017**: 系统必须区分拍照图片识别、三个卡片图片生成、文本生成等不同功能
- **FR-018**: 系统必须支持流式返回文字和图片内容
- **FR-019**: 系统必须支持意图识别，明确区分生成卡片意图和文本回答意图
- **FR-020**: 系统必须支持多轮对话，保持上下文理解

### 非功能需求

- **NFR-001**: 所有按钮点击响应时间必须≤200ms（90%请求）
- **NFR-002**: 语言切换响应时间必须≤100ms
- **NFR-003**: 卡片导出响应时间必须≤2秒（90%请求）
- **NFR-004**: 意图识别准确率必须≥85%（目标90%+）
- **NFR-005**: 数据存储成功率必须≥99%
- **NFR-006**: AI模型调用失败时必须有降级策略
- **NFR-007**: 移动端交互必须流畅，支持touch事件
- **NFR-008**: 卡片大小必须符合设计规范，不能被压缩变形

### 关键实体 *(包含数据)*

- **对话消息 (ConversationMessage)**: 对话消息列表中的消息项，包括文本消息、卡片消息、图片消息等
  - `id`: 消息ID
  - `type`: 消息类型（text/card/image/voice）
  - `content`: 消息内容
  - `timestamp`: 消息时间戳
  - `sender`: 发送者（user/assistant）

- **用户设置 (UserSettings)**: 用户设置信息，包括语言、年级等
  - `language`: 语言设置（zh/en）
  - `grade`: 年级设置（K1-K12）
  - `lastUpdated`: 最后更新时间

- **收藏卡片 (CollectedCard)**: 用户收藏的卡片
  - `id`: 卡片ID
  - `cardData`: 卡片数据
  - `collectedAt`: 收藏时间
  - `explorationId`: 关联的探索记录ID

- **探索记录 (ExplorationRecord)**: 用户的探索记录
  - `id`: 记录ID
  - `objectName`: 对象名称
  - `objectCategory`: 对象类别
  - `cards`: 生成的卡片列表
  - `timestamp`: 探索时间

- **意图识别结果 (IntentResult)**: 意图识别结果
  - `intent`: 意图类型（generate_cards/text_response/image_recognition）
  - `confidence`: 置信度
  - `parameters`: 意图参数

## 成功标准 *(必填)*

### 功能成功标准

1. **交互功能完整性**：所有按钮都有真实功能响应，没有假逻辑或点击无反应的情况
2. **多语言支持**：支持中英文切换，默认中文，语言设置持久化保存
3. **对话式交互**：生成的卡片显示在对话消息列表中，支持继续追问，支持多种输入方式
4. **意图识别准确性**：意图识别准确率≥85%，能正确区分生成卡片意图和文本回答意图
5. **卡片收藏导出**：支持卡片收藏和导出，卡片页面细节完整，大小符合设计规范
6. **数据持久化**：前端数据存储在本地缓存，服务端数据存储在内存缓存，数据不丢失
7. **AI模型调用**：使用eino框架搭建Agent系统，通过graph图串联整个流程，支持流式返回

### 技术成功标准

1. **性能指标**：按钮点击响应时间≤200ms，语言切换响应时间≤100ms，卡片导出响应时间≤2秒
2. **可靠性指标**：数据存储成功率≥99%，AI模型调用失败时有降级策略
3. **用户体验指标**：移动端交互流畅，支持touch事件，卡片大小符合设计规范

## 假设与依赖

### 假设

- 用户设备支持相机和相册访问
- 用户设备支持语音输入（麦克风权限）
- 用户设备支持现代浏览器（支持IndexedDB和localStorage）
- 网络连接稳定（AI模型调用需要网络）
- eino框架已正确配置，可以调用AI模型
- AI服务地址和认证信息已配置在根目录的.env配置文件中，使用Bearer Token认证（不将具体域名写入MD文档）

### 依赖

- 前端框架：React 18 + Vite + Tailwind CSS
- 后端框架：go-zero + eino框架
- AI模型服务：通过go-zero + eino框架调用
  - AI服务地址：存储在根目录的.env配置文件中（不将具体域名写入MD文档）
  - 认证方式：`Authorization: Bearer ${TAL_MLOPS_APP_ID}:${TAL_MLOPS_APP_KEY}`（存储在.env文件中）
  - 模型类型：图片识别模型、文本生成模型、图片生成模型
  - 配置方式：域名和认证信息存储在根目录的.env配置文件中，通过环境变量读取
- 存储：前端IndexedDB + localStorage，后端内存缓存
- 通信：WebSocket或SSE（流式传输）

## 范围界定

### 包含在本功能中

- 所有按钮的真实功能实现
- 中英文切换功能
- 对话式交互系统
- 卡片收藏和导出功能
- 数据存储和同步
- AI模型调用和Agent系统
- 多模态输入和意图识别

### 不包含在本功能中

- 用户账户系统（MVP版本仍为匿名使用）
- 跨设备数据同步（MVP版本数据仅本地存储）
- 复杂的权限管理（MVP版本使用基础权限）
- 高级的AI模型训练和优化（使用现有AI模型）

## 相关文档

- 项目规范：`.specify/memory/constitution.md`
- 功能规范：`specs/001-multimodal-exploration/spec.md`
- 实现计划：`specs/001-multimodal-exploration/plan.md`

