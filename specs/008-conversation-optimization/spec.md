# 功能规范：对话体验与性能优化

**功能分支**: `008-conversation-optimization`  
**创建日期**: 2025-12-20  
**状态**: 草稿  
**输入**: 用户描述：1.前端-对话页-流式消息打字机效果有问题，接口流式返回，但是前端没有及时渲染，而是最后渲染；2. 前端-对话页-流式收到消息需要支持markdown格式进行渲染，目前看是纯文本；3. 优化/api/explore/generate-cards接口，从40s优化到5s内；4.生成的知识卡片支持通过listen按钮听到知识内容(文本转语音)

## 用户场景与测试 *(必填)*

### 用户故事 1 - 流式消息实时渲染（优先级: P1）

用户在对话页面发送消息后，系统通过流式返回响应内容。用户期望看到实时的打字机效果，即每个字符或文本片段到达后立即显示在界面上，而不是等待所有内容接收完毕后才一次性渲染。

**为什么是最高优先级**：这是对话体验的核心问题，直接影响用户对系统响应速度的感知。如果流式消息不能实时渲染，用户会感觉系统响应缓慢，即使后端已经在实时返回数据。这违反了项目规范（原则八）中关于流式消息实时渲染的要求，必须优先修复。

**独立测试**：可以完全独立测试，在对话页面发送消息后，观察系统响应是否在接收到流式数据后立即更新UI，而不是等待流结束。可以通过网络节流工具验证在不同网络条件下的实时渲染效果。

**接受场景**：

1. **Given** 用户在对话页面发送消息，**When** 系统开始通过流式传输返回响应，**Then** 界面在接收到第一个数据片段后立即更新显示，显示已接收的内容
2. **Given** 系统正在流式返回消息内容，**When** 每个字符或文本片段到达前端，**Then** 该片段立即追加显示在对话界面中，实现真正的打字机效果
3. **Given** 系统正在流式返回消息，**When** 用户观察对话界面，**Then** 用户能看到内容逐字或逐段出现，而不是长时间空白后突然显示完整内容
4. **Given** 流式传输过程中，**When** 网络出现短暂中断后恢复，**Then** 已接收的内容仍然显示在界面上，新内容继续追加显示
5. **Given** 流式消息传输完成，**When** 用户查看最终消息，**Then** 消息内容完整且正确，与一次性渲染的结果一致

---

### 用户故事 2 - 流式消息Markdown格式支持（优先级: P1）

用户在对话页面接收系统响应时，系统返回的内容可能包含Markdown格式（如标题、列表、代码块、链接等）。用户期望看到正确格式化的内容，而不是纯文本显示。

**为什么是最高优先级**：Markdown格式支持是内容展示质量的关键，直接影响用户对内容的阅读和理解。纯文本显示会降低内容的可读性和专业性，特别是对于包含代码、列表等结构化内容的响应。这符合项目规范（原则八）中关于Markdown格式支持的要求。

**独立测试**：可以完全独立测试，在对话中发送会触发Markdown格式响应的问题（如要求代码示例、列表等），验证响应内容是否正确渲染为格式化的Markdown，而不是纯文本。

**接受场景**：

1. **Given** 系统返回包含Markdown格式的流式消息，**When** 界面接收到消息内容，**Then** 界面解析并显示格式化内容，正确渲染Markdown格式
2. **Given** 系统返回包含标题、列表、代码块等Markdown元素的响应，**When** 内容显示在对话界面，**Then** 这些元素以正确的格式显示（标题加粗、列表有序/无序、代码块有语法高亮等）
3. **Given** 系统正在流式返回Markdown格式内容，**When** 内容逐字显示，**Then** Markdown渲染与流式输出同步更新，实时显示格式化结果
4. **Given** 系统返回包含链接的Markdown内容，**When** 链接显示在对话界面，**Then** 链接可点击且正确跳转
5. **Given** 系统返回包含代码块的Markdown内容，**When** 代码块显示在对话界面，**Then** 代码块有适当的背景色、边框和等宽字体，便于阅读
6. **Given** Markdown渲染与打字机效果同时工作，**When** 内容流式显示，**Then** Markdown渲染不影响打字机效果的流畅性，两者协调工作

---

### 用户故事 3 - 知识卡片生成性能优化（优先级: P1）

用户请求生成知识卡片时，系统需要从当前的40秒响应时间优化到5秒内完成，大幅提升用户体验。

**为什么是最高优先级**：性能是用户体验的关键指标，40秒的等待时间会导致用户流失和体验下降。优化到5秒内符合项目规范（原则三）中关于关键接口响应时间≤5秒的要求。这是可发布应用规范的核心要求，必须优先实现。

**独立测试**：可以完全独立测试，请求生成知识卡片，测量响应时间是否在5秒内完成。可以通过多次请求验证性能优化的稳定性。

**接受场景**：

1. **Given** 用户请求生成知识卡片，**When** 系统处理生成请求，**Then** 系统在5秒内返回知识卡片结果
2. **Given** 系统正在生成知识卡片，**When** 生成时间超过2秒，**Then** 系统向用户显示进度提示，告知用户正在处理中
3. **Given** 系统生成知识卡片，**When** 生成完成，**Then** 返回的卡片内容完整且正确，与优化前的内容质量一致
4. **Given** 系统在高峰期处理多个卡片生成请求，**When** 并发请求增加，**Then** 系统仍能在5秒内响应大部分请求（95%的请求在5秒内完成）
5. **Given** 系统优化后，**When** 用户多次生成卡片，**Then** 响应时间稳定在5秒内，不会出现偶尔超时的情况

---

### 用户故事 4 - 知识卡片文本转语音功能（优先级: P2）

用户在查看知识卡片时，可以通过点击"听"按钮（listen按钮）将卡片内容转换为语音播放，支持听觉学习方式。

**为什么是第二优先级**：这是增强用户体验的功能，特别适合低龄儿童和阅读能力较弱的学生。虽然不影响核心功能，但能显著提升学习体验和可访问性。这符合项目规范（原则二）中关于知识卡片文本转语音交互的要求。

**独立测试**：可以完全独立测试，在知识卡片上点击"听"按钮，验证语音是否正确播放卡片内容，支持播放控制。

**接受场景**：

1. **Given** 用户在对话页面查看知识卡片，**When** 用户点击卡片上的"听"按钮，**Then** 系统开始播放卡片内容的语音
2. **Given** 系统正在播放卡片语音，**When** 用户点击暂停按钮，**Then** 语音暂停播放，可以继续播放
3. **Given** 系统正在播放卡片语音，**When** 用户点击停止按钮，**Then** 语音停止播放，回到初始状态
4. **Given** 知识卡片包含中文和英文内容，**When** 用户点击"听"按钮，**Then** 系统使用正确的语言和发音播放对应内容
5. **Given** 系统播放卡片语音，**When** 语音播放，**Then** 语音清晰自然，语速适中，适合儿童听力
6. **Given** 用户正在播放一张卡片的语音，**When** 用户切换到另一张卡片并点击"听"按钮，**Then** 前一张卡片的语音停止，开始播放新卡片的语音

---

### 边界情况

- 当流式消息传输过程中网络中断时，系统如何处理已接收的内容和未完成的消息？
- 当Markdown内容包含恶意代码或特殊字符时，系统如何安全渲染？
- 当知识卡片生成请求在5秒内无法完成时，系统如何处理超时情况？
- 当多个用户同时请求生成知识卡片时，系统如何保证性能优化后的响应时间？
- 当文本转语音服务不可用时，系统如何优雅降级？
- 当知识卡片内容过长时，文本转语音如何分段播放？
- 当用户快速连续点击"听"按钮时，系统如何防止重复播放？
- 当流式消息包含大量Markdown格式内容时，渲染性能如何保证？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须在流式消息传输过程中实时渲染内容，不能延迟到最后统一渲染
- **FR-002**: 界面必须在接收到流式数据后立即更新显示，每个字符或文本片段到达后立即显示
- **FR-003**: 系统必须支持流式消息的Markdown格式渲染，正确解析和展示格式化内容
- **FR-004**: 系统必须支持Markdown常用语法：标题、列表、代码块、链接、粗体、斜体等
- **FR-005**: Markdown渲染必须与流式输出同步，实时更新渲染结果
- **FR-006**: 系统必须将知识卡片生成的响应时间从40秒优化到5秒内
- **FR-007**: 系统必须在知识卡片生成过程中提供进度反馈，告知用户处理状态
- **FR-008**: 系统必须保证性能优化后卡片内容的质量和完整性，与优化前一致
- **FR-009**: 知识卡片必须提供"听"按钮（listen按钮），支持文本转语音功能
- **FR-010**: 文本转语音必须支持中文、英文等多种语言，使用正确的发音
- **FR-011**: 文本转语音必须支持播放控制：播放、暂停、停止
- **FR-012**: 文本转语音的语音质量必须清晰自然，语速适中，适合儿童听力
- **FR-013**: 系统必须在流式消息实时渲染和Markdown渲染过程中保持流畅的用户体验
- **FR-014**: 系统必须在性能优化过程中保持功能正确性，不能因优化引入错误

### 关键实体 *(如功能涉及数据)*

- **流式消息（Streaming Message）**：通过流式传输实时传输的消息内容，必须实时渲染
- **Markdown内容（Markdown Content）**：包含Markdown格式的消息内容，需要格式化渲染
- **知识卡片（Knowledge Card）**：包含文本内容的知识卡片，支持文本转语音功能
- **语音播放状态（Audio Playback State）**：文本转语音的播放、暂停、停止状态

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 流式消息在接收到第一个数据片段后，UI在100毫秒内更新显示
- **SC-002**: 流式消息的实时渲染准确率达到100%，所有接收到的内容都正确显示
- **SC-003**: 95%的Markdown格式内容能够正确渲染，格式显示准确
- **SC-004**: Markdown渲染与流式输出的同步延迟不超过200毫秒
- **SC-005**: 知识卡片生成的响应时间从40秒优化到5秒内，95%的请求在5秒内完成
- **SC-006**: 性能优化后，知识卡片内容的质量和完整性保持100%，与优化前一致
- **SC-007**: 文本转语音功能的可用性达到99%，语音播放成功启动
- **SC-008**: 文本转语音的语音清晰度评分达到4.0/5.0以上（用户评分）
- **SC-009**: 用户能够通过播放控制功能（播放、暂停、停止）完全控制语音播放
- **SC-010**: 90%的用户认为流式消息实时渲染提升了对话体验
- **SC-011**: 85%的用户认为Markdown格式支持提升了内容可读性
- **SC-012**: 95%的用户认为知识卡片生成速度优化显著提升了使用体验
