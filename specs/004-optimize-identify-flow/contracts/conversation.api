// TanGo 对话服务 API 定义
// 使用 go-zero API 定义格式
// 优化识别流程与对话体验

syntax = "v1"

info (
	title: "TanGo 对话服务 API"
	desc: "TanGo（小探号）对话交互功能API - 优化版本"
	version: "1.1.0"
	author: "TanGo Team"
)

type (
	// 对话消息请求
	ConversationRequest {
		SessionId    string `json:"sessionId,optional"`    // 会话ID，如果为空则创建新会话
		Message      string `json:"message"`               // 用户消息内容
		MessageType  string `json:"messageType"`            // 消息类型：text/image/voice
		Image        string `json:"image,optional"`        // 图片数据（base64或URL），当messageType为image时必填
		// 识别结果上下文（可选，用于关联识别结果）
		IdentificationContext *IdentificationContext `json:"identificationContext,optional"`
	}

	// 识别结果上下文
	IdentificationContext {
		ObjectName     string  `json:"objectName"`     // 对象名称
		ObjectCategory string  `json:"objectCategory"` // 对象类别
		Confidence     float64 `json:"confidence"`     // 识别置信度
		Keywords       []string `json:"keywords,optional"` // 相关关键词
		Age            int     `json:"age,optional"`   // 用户年龄
	}

	// 对话消息响应
	ConversationResponse {
		SessionId string                `json:"sessionId"` // 会话ID
		Message   ConversationMessage   `json:"message"`   // 系统响应消息
		// 是否使用流式返回（如果为true，客户端应建立SSE连接）
		UseStreaming bool `json:"useStreaming,optional"`
	}

	// 对话消息
	ConversationMessage {
		Id          string      `json:"id"`          // 消息ID
		SessionId   string      `json:"sessionId"`  // 会话ID
		Type        string      `json:"type"`        // 消息类型：text/image/voice/card
		Sender      string      `json:"sender"`      // 发送者：user/assistant
		Content     interface{} `json:"content"`     // 消息内容
		Timestamp   string      `json:"timestamp"`   // 时间戳（ISO 8601格式）
		IsStreaming *bool       `json:"isStreaming,optional"` // 是否正在流式返回
	}

	// 知识卡片（对话中展示时只包含文本，不包含图片）
	KnowledgeCard {
		Id      string      `json:"id"`      // 卡片ID
		Type    string      `json:"type"`    // 卡片类型：science/poetry/english
		Title   string      `json:"title"`   // 卡片标题
		Content CardContent `json:"content"` // 卡片内容
	}

	// 卡片内容（图片字段保留但不显示）
	CardContent {
		Text  string `json:"text"`  // 文本内容（必显示）
		Image string `json:"image,optional"` // 图片URL或base64（保留但不显示）
	}

	// 流式返回事件类型
	StreamEventType {
		Type    string      `json:"type"`    // 事件类型：message_start/message_delta/message_end/card_start/card_delta/card_end/error
		Data    interface{} `json:"data"`    // 事件数据
		MessageId string    `json:"messageId,optional"` // 消息ID
		SessionId  string   `json:"sessionId"` // 会话ID
	}

	// 意图识别请求
	IntentRequest {
		Message   string `json:"message"`   // 用户消息
		SessionId string `json:"sessionId"` // 会话ID
	}

	// 意图识别响应
	IntentResponse {
		Intent     string  `json:"intent"`     // 意图类型：generate_cards/text_response/other
		Confidence float64 `json:"confidence"` // 置信度
	}

	// 错误响应
	ErrorResponse {
		Code    int    `json:"code"`    // 错误码
		Message string `json:"message"` // 错误信息
		Detail  string `json:"detail,optional"` // 错误详情
	}
)

service conversation {
	// 处理对话消息
	@handler ConversationHandler
	post /api/conversation/message (ConversationRequest) returns (ConversationResponse)

	// 流式返回对话响应（SSE）
	@handler ConversationStreamHandler
	get /api/conversation/stream/:sessionId returns (stream StreamEventType)

	// 识别用户意图
	@handler IntentHandler
	post /api/conversation/intent (IntentRequest) returns (IntentResponse)

	// 获取会话历史
	@handler GetHistoryHandler
	get /api/conversation/history/:sessionId returns ([]ConversationMessage)

	// 创建新会话（可选，通常通过发送第一条消息自动创建）
	@handler CreateSessionHandler
	post /api/conversation/session returns (SessionResponse)
}

type (
	// 会话响应
	SessionResponse {
		SessionId string `json:"sessionId"` // 会话ID
		CreatedAt string `json:"createdAt"` // 创建时间
	}
)
