# 任务清单：对话页面会话记录持久化

**输入**: 设计文档来自 `/specs/013-conversation-persistence/`
**前置条件**: plan.md (必需), spec.md (必需，用于用户故事)

**注意**: 本次优化主要在前端进行，优化Result.tsx中的持久化和恢复逻辑，确保所有消息和上下文信息正确保存和恢复。

**组织方式**: 任务按用户故事分组，支持独立实现和测试每个故事。

## 格式说明: `[ID] [P?] [Story] 描述`

- **[P]**: 可以并行执行（不同文件，无依赖）
- **[Story]**: 该任务属于哪个用户故事（如 US1, US2, US3）
- 描述中包含确切的文件路径

## 路径约定

- **Web应用**: `frontend/src/`
- 路径基于 plan.md 中的项目结构

---

## Phase 1: 优化消息保存逻辑（阻塞前置条件）

**目的**: 确保所有消息（包括流式消息完成时）正确保存到IndexedDB，流式消息完成时清除`isStreaming`和`streamingText`字段

**⚠️ 关键**: 在完成此阶段之前，无法确保消息正确持久化

### 1.1 优化流式消息保存逻辑

- [x] T001 [US1] 优化文本消息流式完成时的保存 `frontend/src/pages/Result.tsx`
  - 在`handleSendMessage`的`onClose`回调中，确保保存的消息不包含`isStreaming: true`
  - 清除`streamingText`字段再保存到IndexedDB
  - 确保保存的消息包含完整的`content`字段
  - 添加错误处理，如果保存失败，记录日志但不中断用户操作

**验收标准**:
- 流式消息完成时，保存的消息不包含`isStreaming: true`
- 保存的消息包含完整的`content`字段
- 错误处理正确，不中断用户操作

- [x] T002 [US1] 优化语音消息流式完成时的保存 `frontend/src/pages/Result.tsx`
  - 在`handleVoiceResult`的`onClose`回调中，确保保存的消息不包含`isStreaming: true`
  - 清除`streamingText`字段再保存到IndexedDB
  - 确保保存的消息包含完整的`content`字段
  - 添加错误处理

**验收标准**: 同T001

- [x] T003 [US1] 优化图片消息流式完成时的保存 `frontend/src/pages/Result.tsx`
  - 在`handleImageSelect`的`onClose`回调中，确保保存的消息不包含`isStreaming: true`
  - 清除`streamingText`字段再保存到IndexedDB
  - 确保保存的消息包含完整的`content`字段
  - 添加错误处理

**验收标准**: 同T001

- [x] T004 [US1] 优化卡片生成完成时的保存 `frontend/src/pages/Result.tsx`
  - 在`generateCardsAutomatically`的`onComplete`回调中，确保所有卡片消息正确保存
  - 确保流式文本消息（如果有）完成时清除`isStreaming`字段
  - 确保所有卡片消息的`sessionId`正确
  - 添加错误处理

**验收标准**:
- 所有卡片消息正确保存到IndexedDB
- 流式文本消息（如果有）完成时清除`isStreaming`字段
- 卡片消息的`sessionId`正确

**检查点**: 消息保存逻辑优化完成 - 所有消息（包括流式消息）正确保存到IndexedDB ✅

---

## Phase 2: User Story 1 - 刷新页面后恢复对话记录 (Priority: P1) 🎯 MVP

**目标**: 用户在对话页面进行对话后，刷新浏览器页面或关闭后重新打开，系统能够自动恢复之前的对话记录，包括所有消息、卡片和识别结果上下文

**独立测试**: 用户在对话页面进行多轮对话（包括文本、语音、图片消息和卡片生成），然后刷新浏览器页面，系统能够自动恢复所有对话记录，包括消息列表、识别结果信息和会话状态，用户可以继续之前的对话。

### 2.1 优化恢复对话记录函数

- [x] T005 [US1] 优化restoreConversation函数 `frontend/src/pages/Result.tsx`
  - 确保恢复时所有流式消息标记为已完成（清除`isStreaming`和`streamingText`字段）
  - 确保消息按时间顺序恢复（使用`timestamp`排序）
  - 添加数据验证，确保恢复的消息格式正确
  - 添加错误处理，如果恢复失败，显示友好提示
  - 优化恢复性能，使用异步加载，不阻塞UI渲染

**验收标准**:
- 恢复时所有流式消息标记为已完成
- 消息按时间顺序恢复
- 数据验证正确
- 错误处理完善
- 恢复时间≤2秒

- [x] T006 [US1] 优化恢复识别结果上下文 `frontend/src/pages/Result.tsx`
  - 确保`restoreIdentificationContext`函数正确恢复所有字段
  - 添加数据验证，确保恢复的上下文格式正确
  - 添加错误处理，如果恢复失败，使用默认值
  - 确保恢复的上下文与消息的`sessionId`一致

**验收标准**:
- 识别结果上下文完整恢复
- 数据验证正确
- 错误处理完善
- 上下文与消息的`sessionId`一致

- [x] T007 [US1] 优化恢复卡片生成状态 `frontend/src/pages/Result.tsx`
  - 在恢复对话记录后，检测是否已有卡片消息
  - 如果有卡片消息，设置`hasGeneratedCardsRef.current = true`
  - **重要**：判断逻辑应该是"是否需要生成卡片"（即是否已经有卡片了），而不是"是否有需要识别就重新生成卡片"
  - 确保不会重新生成卡片（如果已有卡片消息）
  - 添加日志记录，便于调试

**验收标准**:
- 检测卡片消息正确
- 判断逻辑正确（判断是否已有卡片，而不是判断是否需要识别）
- 不会重新生成卡片（如果已有卡片消息）
- 日志记录完善

### 2.2 优化页面初始化逻辑

- [x] T008 [US1] 优化useEffect初始化逻辑 `frontend/src/pages/Result.tsx`
  - 确保页面加载时正确检测是否需要恢复会话
  - 如果没有新识别结果（`location.state`为空），尝试恢复之前的会话
  - 确保恢复逻辑在正确的时机执行
  - 优化依赖项，避免不必要的重复执行

**验收标准**:
- 页面加载时正确检测是否需要恢复
- 恢复逻辑在正确的时机执行
- 依赖项优化正确

- [x] T009 [US1] 添加恢复失败的处理 `frontend/src/pages/Result.tsx`
  - 如果恢复失败，显示友好提示
  - 引导用户重新开始对话或返回首页
  - 记录错误日志，便于调试
  - 确保不会导致页面崩溃

**验收标准**:
- 恢复失败时显示友好提示
- 错误处理完善
- 不会导致页面崩溃

**检查点**: User Story 1完成 - 刷新页面后能够恢复所有对话记录 ✅

---

## Phase 3: User Story 2 - 切换页面后保持对话记录 (Priority: P1) 🎯 MVP

**目标**: 用户在对话页面进行对话后，切换到其他页面（如首页、收藏页等），然后返回对话页面，系统能够保持并恢复之前的对话记录

**独立测试**: 用户在对话页面进行多轮对话，然后通过导航切换到其他页面（如首页），再返回对话页面，系统能够保持并恢复所有对话记录，包括消息列表和识别结果上下文，用户可以继续之前的对话。

### 3.1 优化页面切换恢复逻辑

- [x] T010 [US2] 优化location变化监听 `frontend/src/pages/Result.tsx`
  - 确保`useEffect`正确监听`location`变化
  - 当从其他页面返回时，如果`location.state`为空，尝试恢复之前的会话
  - 确保不会重复恢复（使用`isInitializedRef`防止重复初始化）
  - 优化依赖项，避免不必要的重复执行

**验收标准**:
- location变化时正确触发恢复
- 不会重复恢复
- 依赖项优化正确

- [x] T011 [US2] 优化浏览器后退按钮处理 `frontend/src/pages/Result.tsx`
  - 确保通过浏览器后退按钮返回时，能够正确恢复对话记录
  - 处理浏览器历史记录中的状态
  - 确保恢复逻辑在正确的时机执行

**验收标准**:
- 浏览器后退按钮返回时正确恢复
- 恢复逻辑在正确的时机执行

### 3.2 优化会话状态管理

- [x] T012 [US2] 确保会话ID正确保存 `frontend/src/pages/Result.tsx`
  - 确保每次发送消息时，会话ID已正确设置
  - 确保切换页面时，会话ID不会丢失
  - 添加验证，确保会话ID与消息的`sessionId`一致

**验收标准**:
- 会话ID正确保存
- 切换页面时不会丢失
- 会话ID与消息的`sessionId`一致

- [x] T013 [US2] 优化多会话处理 `frontend/src/pages/Result.tsx`
  - 确保恢复时使用正确的会话ID（从localStorage读取`currentSessionId`）
  - 如果用户有多个会话，恢复最近活跃的会话
  - 确保不同会话的数据不会混淆

**验收标准**:
- 恢复时使用正确的会话ID
- 恢复最近活跃的会话
- 不同会话的数据不会混淆

**检查点**: User Story 2完成 - 切换页面后能够保持并恢复对话记录 ✅

---

## Phase 4: User Story 3 - 重新拍照上传时创建新会话 (Priority: P1) 🎯 MVP

**目标**: 用户从拍照页面（Capture页面）选择图片并识别后跳转到对话页面时，系统创建新的会话，清空之前的对话记录，开始全新的对话流程

**重要区分**：
- **拍照上传**：从Capture页面选择图片并识别，通过`location.state`传递识别结果跳转到Result页面 → **创建新会话**
- **上传图片**：在对话页面中通过ImageInput组件上传图片 → **继续当前会话**，不创建新会话

**独立测试**: 用户在对话页面有之前的对话记录，然后从拍照页面（Capture页面）选择图片并识别后跳转到对话页面，系统创建新的会话（新的会话ID），清空之前的对话记录，显示新的识别结果和新的消息列表，开始全新的对话流程。在对话页面中通过ImageInput组件上传图片时，应该继续当前会话，不创建新会话。

### 4.1 优化新会话创建逻辑

- [x] T014 [US3] 优化新会话创建检测 `frontend/src/pages/Result.tsx`
  - 确保正确检测从Capture页面传入的新识别结果（`location.state`包含`objectName`且为有效字符串）
  - 确保新会话创建逻辑在正确的时机执行
  - **重要**：确保在对话页面中通过ImageInput组件上传图片时，不会触发新会话创建（使用当前sessionId，继续当前会话）
  - 添加日志记录，便于调试

**验收标准**:
- 正确检测新识别结果（`location.state`包含`objectName`且为有效字符串）
- 新会话创建逻辑在正确的时机执行
- 在对话页面中上传图片时，不会创建新会话，继续当前会话
- 日志记录完善

- [x] T015 [US3] 确保新会话ID正确生成和保存 `frontend/src/pages/Result.tsx`
  - 生成新的会话ID（格式：`session-${Date.now()}-${random}`）
  - 立即保存新会话ID到localStorage（替换之前的会话ID）
  - 确保新会话ID与消息的`sessionId`一致
  - 添加验证，确保会话ID格式正确

**验收标准**:
- 新会话ID正确生成
- 新会话ID正确保存到localStorage
- 新会话ID与消息的`sessionId`一致

- [x] T016 [US3] 确保新识别结果上下文正确保存 `frontend/src/pages/Result.tsx`
  - 保存新的识别结果上下文到localStorage（替换之前的上下文）
  - 确保所有字段正确保存（objectName、objectCategory、confidence、keywords、age等）
  - 添加数据验证，确保上下文格式正确

**验收标准**:
- 新识别结果上下文正确保存
- 所有字段正确保存
- 数据验证正确

- [x] T017 [US3] 确保旧会话数据不干扰新会话 `frontend/src/pages/Result.tsx`
  - 清空当前消息列表（内存中的状态）→ `setMessages([])`
  - 生成新会话ID并保存到localStorage（替换旧的sessionId）
  - 保存新的识别结果上下文到localStorage（替换旧的上下文）
  - 重置`hasGeneratedCardsRef.current = false`，允许生成新卡片
  - 确保新会话使用新的sessionId，旧会话数据保留在IndexedDB中（不删除，支持历史记录）
  - 确保新会话的初始消息正确创建和保存
  - 添加日志记录，确保清空和创建流程清晰

**验收标准**:
- 从Capture页面进入时，旧会话数据不干扰新会话
- 新会话ID正确生成并替换旧的sessionId
- 新识别结果上下文正确保存并替换旧的上下文
- 新会话的初始消息正确创建和保存
- 旧会话数据保留在IndexedDB中

### 4.2 优化初始消息创建

- [x] T018 [US3] 优化初始图片消息创建 `frontend/src/pages/Result.tsx`
  - 确保用户图片消息正确创建（如果有`imageData`）
  - 确保图片消息的`sessionId`正确
  - 确保图片消息正确保存到IndexedDB
  - 添加错误处理

**验收标准**:
- 初始图片消息正确创建
- 图片消息的`sessionId`正确
- 图片消息正确保存到IndexedDB

- [x] T019 [US3] 优化初始识别结果消息创建 `frontend/src/pages/Result.tsx`
  - 确保识别结果消息正确创建
  - 确保识别结果消息的`sessionId`正确
  - 确保识别结果消息正确保存到IndexedDB
  - 添加错误处理

**验收标准**:
- 初始识别结果消息正确创建
- 识别结果消息的`sessionId`正确
- 识别结果消息正确保存到IndexedDB

- [x] T019A [US3] 确保上传图片时继续当前会话 `frontend/src/pages/Result.tsx`
  - 在`handleImageSelect`函数中，确保使用当前`sessionId`，不清空消息列表
  - 确保上传图片时不会触发新会话创建逻辑
  - 确保上传图片时不会传递`identificationContext`给流式请求（不生成卡片）
  - 确保上传图片的消息正确保存到IndexedDB，使用当前`sessionId`
  - 添加注释说明，区分"拍照上传"和"上传图片"的处理逻辑

**验收标准**:
- 在对话页面中上传图片时，使用当前`sessionId`，继续当前会话
- 上传图片时不清空消息列表
- 上传图片时不会触发新会话创建
- 上传图片的消息正确保存到IndexedDB

**检查点**: User Story 3完成 - 重新拍照上传时能够正确创建新会话，上传图片时继续当前会话 ✅

---

## Phase 5: 优化错误处理和降级策略 (Priority: P1)

**目的**: 添加完善的错误处理，实现优雅降级策略，确保在IndexedDB失败时至少使用localStorage保存关键信息

### 5.1 优化IndexedDB错误处理

- [x] T020 [P] 优化conversationStorage错误处理 `frontend/src/services/storage.ts`
  - 捕获`QuotaExceededError`，提示用户清理存储空间
  - 捕获其他IndexedDB错误，降级到localStorage保存关键信息
  - 记录错误日志，但不中断用户操作
  - 添加重试机制（可选）

**验收标准**:
- IndexedDB错误处理完善
- 降级策略正确
- 错误日志记录完善

- [x] T021 [P] 优化消息保存的错误处理 `frontend/src/pages/Result.tsx`
  - 在所有消息保存操作中添加错误处理
  - 如果IndexedDB保存失败，尝试降级到localStorage保存关键信息
  - 记录错误日志，但不中断用户操作
  - 显示友好的错误提示（可选）

**验收标准**:
- 消息保存错误处理完善
- 降级策略正确
- 错误日志记录完善

### 5.2 优化localStorage错误处理

- [x] T022 [P] 优化localStorage保存的错误处理 `frontend/src/pages/Result.tsx`
  - 在保存sessionId和identificationContext时添加错误处理
  - 捕获`QuotaExceededError`，提示用户清理存储空间
  - 捕获其他localStorage错误，记录日志，但不中断用户操作
  - 添加重试机制（可选）

**验收标准**:
- localStorage错误处理完善
- 错误日志记录完善

### 5.3 优化恢复失败处理

- [x] T023 [P] 优化恢复失败的处理 `frontend/src/pages/Result.tsx`
  - 如果恢复失败，显示友好提示
  - 引导用户重新开始对话或返回首页
  - 如果部分数据恢复失败，尽可能恢复可用数据
  - 记录错误日志，便于调试

**验收标准**:
- 恢复失败处理完善
- 友好提示正确
- 错误日志记录完善

**检查点**: 错误处理和降级策略优化完成 ✅

---

## Phase 6: 测试与验证 (Priority: P1)

**目的**: 确保所有功能正常工作，性能指标达标，符合成功标准

### 6.1 功能测试

- [ ] T024 [P] 测试刷新页面后恢复对话记录 `frontend/src/pages/Result.tsx`
  - 测试多轮对话后刷新页面
  - 验证所有消息（文本、语音、图片、卡片）正确恢复
  - 验证识别结果上下文正确恢复
  - **重要**：验证如果已有卡片消息，刷新页面后不会重新生成卡片
  - 验证恢复时间≤2秒
  - 验证恢复成功率100%

- [ ] T025 [P] 测试切换页面后保持对话记录 `frontend/src/pages/Result.tsx`
  - 测试切换到首页后返回
  - 测试切换到收藏页后返回
  - 测试通过浏览器后退按钮返回
  - 验证对话记录正确恢复
  - 验证恢复时间≤1秒
  - 验证恢复成功率100%

- [ ] T026 [P] 测试重新拍照上传时创建新会话 `frontend/src/pages/Result.tsx`
  - 测试从拍照页面（Capture页面）选择图片并识别后跳转到对话页面
  - 验证新会话ID正确生成和保存
  - 验证新识别结果上下文正确保存
  - 验证旧会话数据不干扰新会话
  - 验证新会话创建成功率100%
  - **重要**：测试在对话页面中通过ImageInput组件上传图片时，继续当前会话，不创建新会话

- [ ] T027 [P] 测试流式消息状态处理 `frontend/src/pages/Result.tsx`
  - 测试流式消息完成时，`isStreaming`字段被清除
  - 测试恢复时，所有流式消息标记为已完成
  - 验证流式消息状态处理正确

- [ ] T028 [P] 测试错误处理和降级策略 `frontend/src/pages/Result.tsx`
  - 测试IndexedDB失败时的降级策略
  - 测试localStorage失败时的错误处理
  - 测试恢复失败时的友好提示
  - 验证错误处理正确

### 6.2 性能测试

- [ ] T029 [P] 测试恢复性能 `frontend/src/pages/Result.tsx`
  - 测试恢复大量消息时的性能（1000条消息）
  - 验证恢复时间≤2秒
  - 优化恢复逻辑，使用异步加载

- [ ] T030 [P] 测试保存性能 `frontend/src/pages/Result.tsx`
  - 测试保存大量消息时的性能
  - 验证保存操作不阻塞用户操作
  - 优化保存逻辑，使用异步保存

### 6.3 兼容性测试

- [ ] T031 [P] 测试移动端兼容性
  - 测试iOS Safari
  - 测试Android Chrome
  - 验证持久化功能正常

- [ ] T032 [P] 测试PC端兼容性
  - 测试Chrome浏览器
  - 测试Safari浏览器
  - 验证持久化功能正常

### 6.4 成功标准验证

- [ ] T033 [P] 验证成功标准SC-001至SC-007
  - SC-001: 刷新页面后恢复对话记录时间≤2秒，恢复成功率100%
  - SC-002: 切换页面后恢复对话记录时间≤1秒，恢复成功率100%
  - SC-003: 新会话创建成功率100%
  - SC-004: 消息保存成功率≥99%
  - SC-005: 识别结果上下文保存成功率100%
  - SC-006: 对话连续性保持率100%
  - SC-007: 数据完整性100%，无消息丢失或顺序错误

**检查点**: 测试与验证完成 - 所有功能正常，性能指标达标，符合成功标准 ✅

---

## 依赖关系和执行顺序

### Phase依赖

- **Phase 1 (优化消息保存逻辑)**: 无依赖，可以立即开始
- **Phase 2 (User Story 1)**: 依赖Phase 1完成（需要消息正确保存）
- **Phase 3 (User Story 2)**: 依赖Phase 2完成（需要恢复逻辑）
- **Phase 4 (User Story 3)**: 依赖Phase 1完成（需要新会话创建逻辑）
- **Phase 5 (优化错误处理)**: 依赖Phase 1-4完成（需要所有功能基础）
- **Phase 6 (测试验证)**: 依赖Phase 1-5完成

### 用户故事依赖

- **用户故事1 (P1)**: 依赖Phase 1完成，可以立即开始
- **用户故事2 (P1)**: 依赖用户故事1完成（需要恢复逻辑）
- **用户故事3 (P1)**: 依赖Phase 1完成（需要新会话创建逻辑）

### 并行机会

- Phase 1中的T001-T004可以部分并行（不同消息类型）
- Phase 5中的T020-T023可以并行（不同错误处理）
- Phase 6中的所有测试任务可以并行（标记[P]的任务）

---

## 实施策略

### MVP优先（用户故事1、2、3）

1. 完成Phase 1: 优化消息保存逻辑
2. 完成Phase 2: User Story 1（刷新页面后恢复对话记录）
3. 完成Phase 3: User Story 2（切换页面后保持对话记录）
4. 完成Phase 4: User Story 3（重新拍照上传时创建新会话）
5. **停止并验证**: 测试用户故事1、2、3独立功能
6. 可以演示核心功能

### 增量交付

1. 完成Phase 1 → 消息保存逻辑优化完成 → 演示
2. 添加Phase 2 → 刷新页面恢复功能 → 演示
3. 添加Phase 3 → 切换页面保持功能 → 演示
4. 添加Phase 4 → 新会话创建功能 → 演示
5. 添加Phase 5 → 错误处理优化 → 演示
6. 添加Phase 6 → 全面测试验证 → 演示
7. 每个阶段独立交付价值

### 当前阶段重点

**优先完成**:
1. Phase 1: 优化消息保存逻辑（阻塞所有后续工作）
2. Phase 2: User Story 1（刷新页面后恢复对话记录）
3. Phase 3: User Story 2（切换页面后保持对话记录）
4. Phase 4: User Story 3（重新拍照上传时创建新会话）

**后续完成**:
- Phase 5: 优化错误处理和降级策略
- Phase 6: 全面测试验证

---

## 注意事项

- [P] 任务 = 不同文件，无依赖，可以并行
- [Story] 标签映射任务到特定用户故事，便于追踪
- 每个用户故事应该可以独立完成和测试
- 提交代码前验证功能可用
- 在每个检查点停止验证故事独立性
- 避免：模糊任务、同一文件冲突、破坏独立性的跨故事依赖
- 所有消息保存操作必须包含错误处理
- 流式消息完成时必须清除`isStreaming`和`streamingText`字段
- 恢复时所有流式消息必须标记为已完成
- 新会话创建时必须清空旧会话的内存状态，但保留IndexedDB数据
- 性能指标必须达标（恢复时间、保存成功率）

---

## 任务统计

**总任务数**: 34个任务（新增T019A）
**已完成任务**: 24个任务
**完成率**: 71%

**按用户故事分布**:
- User Story 1 (US1): 9个任务 (T001-T009)
- User Story 2 (US2): 4个任务 (T010-T013)
- User Story 3 (US3): 7个任务 (T014-T019, T019A)
- 错误处理: 4个任务 (T020-T023)
- 测试任务: 10个任务 (T024-T033)

**按优先级分布**:
- P1优先级: 33个任务（所有任务都是P1优先级）

**并行任务**: 14个任务可以并行执行（标记[P]的任务）

**预计完成时间**: 
- Phase 1: 1-2天
- Phase 2: 1-2天
- Phase 3: 1天
- Phase 4: 1-2天
- Phase 5: 1天
- Phase 6: 2-3天
- **总计**: 7-11天

**状态**: 待开始 ⏳