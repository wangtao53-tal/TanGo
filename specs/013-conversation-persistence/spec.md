# Feature Specification: 对话页面会话记录持久化

**Feature Branch**: `dev-mvp-20251218`  
**Created**: 2025-12-20  
**Status**: Draft  
**Input**: User description: "前端-对话页面，会话记录，不是刷新页面就没了，现在切到这个页面，或者刷新这个页面，我的对话记录就会消失，只有一个图片发送，然后会重新识别，重新生成卡片，我不要这个效果。而是可以记录我的对话记录，除非我重新点击拍照上传，可以是新的会话开始。"

**Note**: MVP版本阶段，所有开发工作统一在 `dev-mvp-20251218` 分支进行，不采用一个功能一个分支的策略。

## Clarifications

### Session 2025-12-20

- Q: 拍照上传和上传图片的区别是什么？什么时候应该创建新会话？
  → A: **拍照上传**（从Capture页面选择图片并识别后跳转到Result页面）需要创建新会话；**上传图片**（在对话页面中通过ImageInput组件上传图片）应该继续当前会话，不创建新会话

- Q: 刷新对话页面时，卡片生成的判断逻辑是什么？
  → A: 刷新页面时，应该判断是否**已有卡片消息**，如果已有卡片，就不应该重新生成。不应该判断"是否有需要识别就重新生成卡片"，而是判断"是否需要生成卡片"（即是否已经有卡片了）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 刷新页面后恢复对话记录 (Priority: P1)

用户在对话页面进行对话后，刷新浏览器页面或关闭后重新打开，系统能够自动恢复之前的对话记录，包括所有消息、卡片和识别结果上下文，用户可以继续之前的对话，无需重新开始。

**Why this priority**: 这是用户最核心的需求，刷新页面后对话记录消失会严重影响用户体验，用户需要能够随时返回之前的对话上下文，这是对话功能的基本要求。

**Independent Test**: 可以独立测试：用户在对话页面进行多轮对话（包括文本、语音、图片消息和卡片生成），然后刷新浏览器页面，系统能够自动恢复所有对话记录，包括消息列表、识别结果信息和会话状态，用户可以继续之前的对话。这个功能可以独立工作，即使没有其他对话功能，用户也能获得完整的对话持久化体验。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面进行了多轮对话（包括文本消息、语音消息、图片消息和生成的卡片），**When** 用户刷新浏览器页面，**Then** 系统自动恢复所有对话记录，包括完整的消息列表、识别结果上下文（对象名称、分类、置信度等）和会话ID，用户可以继续之前的对话，**不会重新生成卡片**（如果已有卡片消息）
2. **Given** 用户在对话页面进行了对话，**When** 用户关闭浏览器标签页后重新打开对话页面，**Then** 系统自动恢复之前的对话记录，包括所有消息和上下文信息
3. **Given** 用户在对话页面有未完成的流式消息（正在生成中），**When** 用户刷新页面，**Then** 系统恢复已完成的对话记录，流式消息标记为已完成状态，不显示为正在生成中

---

### User Story 2 - 切换页面后保持对话记录 (Priority: P1)

用户在对话页面进行对话后，切换到其他页面（如首页、收藏页等），然后返回对话页面，系统能够保持并恢复之前的对话记录，用户可以继续之前的对话。

**Why this priority**: 用户在使用应用时经常需要在不同页面间切换，如果切换页面后对话记录丢失，会严重影响用户体验，用户需要能够随时返回对话页面继续之前的对话。

**Independent Test**: 可以独立测试：用户在对话页面进行多轮对话，然后通过导航切换到其他页面（如首页），再返回对话页面，系统能够保持并恢复所有对话记录，包括消息列表和识别结果上下文，用户可以继续之前的对话。这个功能可以独立工作，确保用户在不同页面间切换时不会丢失对话记录。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面进行了多轮对话，**When** 用户点击导航切换到首页或其他页面，然后返回对话页面，**Then** 系统自动恢复所有对话记录，包括完整的消息列表和识别结果上下文，用户可以继续之前的对话
2. **Given** 用户在对话页面有多个会话（通过不同识别结果创建），**When** 用户切换到其他页面后返回，**Then** 系统恢复当前活跃会话的对话记录，保持会话的连续性
3. **Given** 用户在对话页面进行了对话，**When** 用户通过浏览器后退按钮返回对话页面，**Then** 系统能够恢复对话记录，保持对话的连续性

---

### User Story 3 - 重新拍照上传时创建新会话 (Priority: P1)

用户从拍照页面（Capture页面）选择图片并识别后跳转到对话页面时，系统创建新的会话，清空之前的对话记录，开始全新的对话流程，包括新的识别结果、新的会话ID和新的消息列表。

**重要区分**：
- **拍照上传**：从Capture页面选择图片并识别，通过`location.state`传递识别结果跳转到Result页面 → **创建新会话**
- **上传图片**：在对话页面中通过ImageInput组件上传图片 → **继续当前会话**，不创建新会话

**Why this priority**: 用户明确表示只有在重新点击拍照上传（从Capture页面）时才应该是新的会话开始，这是用户主动发起新对话的明确意图，系统应该响应这个意图，创建新会话并清空之前的对话记录。在对话页面中上传图片只是继续当前对话，不应该创建新会话。

**Independent Test**: 可以独立测试：用户在对话页面有之前的对话记录，然后从拍照页面上传新图片进行识别，系统创建新的会话（新的会话ID），清空之前的对话记录，显示新的识别结果和新的消息列表，开始全新的对话流程。这个功能可以独立工作，确保用户主动发起新对话时能够获得全新的会话体验。

**Acceptance Scenarios**:

1. **Given** 用户在对话页面有之前的对话记录，**When** 用户从拍照页面上传新图片进行识别，**Then** 系统创建新的会话（新的会话ID），清空之前的对话记录，显示新的识别结果和新的消息列表，开始全新的对话流程
2. **Given** 用户在对话页面有之前的对话记录，**When** 用户从拍照页面上传新图片，系统识别完成后跳转到对话页面，**Then** 系统显示新的识别结果、新的会话ID和新的消息列表（包括用户图片消息和识别结果消息），之前的对话记录不再显示
3. **Given** 用户从拍照页面上传新图片，**When** 系统识别完成后跳转到对话页面，**Then** 系统自动保存新的会话ID和识别结果上下文到本地存储，替换之前的会话信息，确保刷新页面后恢复的是新会话

---

### Edge Cases

- **What happens when** 用户在对话页面有多个会话，刷新页面后系统如何确定恢复哪个会话？
  - **Answer**: 系统应该恢复最近活跃的会话（通过localStorage中的currentSessionId确定），如果用户需要切换会话，可以通过其他功能（如会话列表）实现
  
- **What happens when** 用户在对话页面进行对话，然后从拍照页面（Capture页面）选择图片，但识别失败或取消？
  - **Answer**: 如果识别失败或用户取消，系统应该保持之前的对话记录，不创建新会话，用户可以继续之前的对话
  
- **What happens when** 用户在对话页面中通过ImageInput组件上传图片？
  - **Answer**: 在对话页面中上传图片应该继续当前会话，不创建新会话。图片作为用户消息添加到当前会话中，系统根据图片内容进行对话，但不重新识别对象或生成新的知识卡片
  
- **What happens when** 用户在对话页面有对话记录，然后通过其他方式（如直接输入URL）进入对话页面？
  - **Answer**: 系统应该尝试恢复最近的会话记录，如果没有会话记录，可以显示空状态或引导用户进行拍照识别
  
- **What happens when** 本地存储空间不足或IndexedDB操作失败？
  - **Answer**: 系统应该优雅降级，优先保证关键信息（会话ID和识别结果上下文）的保存，如果IndexedDB操作失败，至少使用localStorage保存基本信息，并在控制台记录错误日志
  
- **What happens when** 用户在对话页面进行对话，然后关闭浏览器，几天后重新打开？
  - **Answer**: 系统应该能够恢复之前的对话记录（如果数据仍然存在），但可能需要考虑数据过期策略，对于过旧的会话（如超过30天），可以选择不恢复或提示用户是否恢复

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 在用户刷新浏览器页面后自动恢复之前的对话记录，包括所有消息、卡片和识别结果上下文
- **FR-002**: 系统 MUST 在用户切换到其他页面后返回对话页面时，自动恢复之前的对话记录，保持对话的连续性
- **FR-003**: 系统 MUST 在用户从拍照页面（Capture页面）选择图片并识别后跳转到对话页面时，创建新的会话，清空之前的对话记录，开始全新的对话流程。注意：在对话页面中通过ImageInput组件上传图片时，应该继续当前会话，不创建新会话
- **FR-004**: 系统 MUST 在创建新会话时，生成新的会话ID并保存到本地存储，替换之前的会话ID
- **FR-005**: 系统 MUST 在保存对话消息时，将消息持久化到IndexedDB，确保刷新页面后能够恢复
- **FR-006**: 系统 MUST 在保存识别结果上下文时，将上下文信息保存到localStorage，确保刷新页面后能够恢复
- **FR-007**: 系统 MUST 在恢复对话记录时，按时间顺序恢复所有消息，保持消息的正确顺序
- **FR-008**: 系统 MUST 在恢复对话记录时，恢复识别结果上下文（对象名称、分类、置信度、关键词、年龄等），确保对话上下文完整
- **FR-009**: 系统 MUST 在恢复对话记录时，检测是否已有卡片消息，如果已有卡片消息，标记为已生成，防止重新生成卡片。刷新页面时，应该判断"是否需要生成卡片"（即是否已经有卡片了），而不是判断"是否有需要识别就重新生成卡片"
- **FR-010**: 系统 MUST 在用户从拍照页面（Capture页面）选择图片并识别后跳转到对话页面时，清空当前消息列表，重置会话状态，准备创建新会话。注意：在对话页面中通过ImageInput组件上传图片时，不清空消息列表，继续当前会话
- **FR-011**: 系统 MUST 在创建新会话时，清空之前的会话ID和识别结果上下文，确保新会话的独立性
- **FR-012**: 系统 MUST 在恢复对话记录时，如果IndexedDB操作失败，至少使用localStorage保存关键信息（会话ID和识别结果上下文），确保基本功能可用

### Key Entities

- **会话记录 (Conversation Session)**: 表示一次完整的对话会话，包含会话ID、消息列表、识别结果上下文、创建时间和最后活跃时间
- **对话消息 (Conversation Message)**: 表示单条对话消息，包含消息ID、类型、内容、发送者、时间戳和会话ID
- **识别结果上下文 (Identification Context)**: 表示图像识别的结果信息，包含对象名称、分类、置信度、关键词、年龄等，用于对话的上下文信息

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在对话页面进行多轮对话后刷新页面，系统能够在2秒内恢复所有对话记录，包括消息列表和识别结果上下文，恢复成功率100%
- **SC-002**: 用户在对话页面进行对话后切换到其他页面，然后返回对话页面，系统能够在1秒内恢复对话记录，恢复成功率100%
- **SC-003**: 用户从拍照页面上传新图片进行识别时，系统能够正确创建新会话并清空之前的对话记录，新会话创建成功率100%
- **SC-004**: 系统能够持久化保存所有对话消息到IndexedDB，消息保存成功率99%以上，支持至少1000条消息的存储
- **SC-005**: 系统能够持久化保存识别结果上下文到localStorage，上下文保存成功率100%，支持至少10个会话的上下文信息
- **SC-006**: 用户在对话页面刷新页面后，能够继续之前的对话，对话连续性保持率100%，用户无需重新开始对话
- **SC-007**: 系统在恢复对话记录时，能够正确恢复消息顺序和识别结果上下文，数据完整性100%，无消息丢失或顺序错误

